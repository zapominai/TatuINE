var main="main",nav="nav",logon="logon",info="info",basement="basement",settings={};String.prototype.format||(String.prototype.format=String.prototype.f=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})});
String.prototype.formatMoney||(String.prototype.formatMoney=function(a){a=a||!1;var b=(""+Math.round(100*this)/100).split("."),c=b[0],b=b[1],e="000",c=c.replace(/\d(?=(\d{3})+$)/g,"$&&thinsp;");b&&1===b.length&&(b+="0");b||(b="00",e="bbb");b=h.span().a(","+b).css({color:e,fontSize:"xx-small"}).outerHtml();return h.span({c:"money"}).a(b&&"int"!==a.type?[c,b].join(""):c).click(function(a){var b=$(this).text().replaceAll(/[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*/g,"");utils.copyToClipboard(b);
!$(this).parents("table#entryTable").length&&a.stopPropagation()})});String.prototype.replaceAll||(String.prototype.replaceAll=function(a,b){return this.split(a).join(b)});String.prototype.isEmpty||(String.prototype.isEmpty=function(){return!this||0===this.length});String.prototype.nl2br||(String.prototype.nl2br=function(a){return(this+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(a||"undefined"===typeof a?"<br />":"<br>")+"$2")});
String.prototype.br2nl||(String.prototype.br2nl=function(){return(this+"").replaceAll("<br>","\n")});String.prototype.htmlDecode||(String.prototype.htmlDecode=function(){return html.textarea().html(this).text()});
String.prototype.truncate||(String.prototype.truncate=function(a){var b=utils.oVal("maxLongWordLen",24,a),c=utils.oVal("showRowsCount",2,a),e=utils.oVal("oneWord",!1,a),f=utils.oVal("maxWidth",!1,a),g=utils.oVal("fontSize",!1,a);a=this;if(e){c=a;if(f)for(b=g?{"font-size":g}:{},e=h.nobr().a(c).css(b).measure(function(){return this.width()}),g=c.length;4<g&&e>f;)c=a.slice(0,g--),e=h.nobr().a(c,c.length<a.length?"&hellip;":"").css(b).measure(function(){return this.width()});else a.length>b&&(c=a.slice(0,
b));c.length<a.length&&(c=c.concat("&hellip;"));return h.nobr().a(c).outerHtml()}f=1<a.split("<br />").length-1;e=a.length>2*b;if(f)for(g=a.split("<br />"),a="",i=0;i<c;i++)a=a.concat("{0}{1}".f(g[i],i===c-1?"":"<br />"));if(e){var c=a.slice(0,2*b),k=a.slice(2*b);$.each(["<br />"," ",".",","],function(a,b){-1<k.indexOf(b)&&(k=k.slice(0,k.indexOf(b)))});a="".concat(c,k)}if(f||e)a=a.concat("&hellip;");return a});
Date.prototype.toDDMMYYYY||(Date.prototype.toDDMMYYYY=function(){var a=this.getDate();10>a&&(a="0"+a);var b=this.getMonth()+1;10>b&&(b="0"+b);var c=this.getFullYear();return"{0}.{1}.{2}".f(a,b,c)});Object.defineProperty(Object.prototype,"oVal",{value:function(a,b){var c=this||!1;return c?c.hasOwnProperty(a)?c[a]:b:b},enumerable:!1});function settings_save(a,b,c){$.ajax({type:"POST",url:"/?action=user.settings.save",data:{tag:a,name:b,value:c}}).done(function(){user.data.load(!0)})}
function empty_cell(){var a=d(basement);a&&(a.innerHTML="");if(a=d("news-nav"))a.innerHTML="";if(a=d(info))a.innerHTML="";if(a=d(main))a.innerHTML="";d("logon").innerHTML=""}function d(a){return document.all?document.all[a]:document.getElementById(a)}
function getElementsByClassName(a){if(document.getElementsByTagName){var b=document.getElementsByTagName("*");a=new RegExp("\\b"+a+"\\b","i");for(var c=[],e=0,f=0;f<b.length;f++)b[f].className&&a.test(b[f].className)&&(c[e]=b[f],e++);return 0==e?!1:c}return!1}function clearHightlightTdById(a,b){b=b||!0;var c=d(a),e=getElementsByClassName("highlight");if(e)for(var f=0;f<e.length;f++)e[f]==c&&(e[f].className=e[f].className.replace("highlight",""),b&&(e[f].innerHTML=""))}
function hightlightTextTD(a,b,c){d(a)&&(d(a).className="highlight"+(void 0===c?"":c),d(a).innerHTML=b)}function overlay(){el=d("overlay");el.style.visibility="visible"==el.style.visibility?"hidden":"visible";"hidden"===el.style.visibility&&(el.innerHTML="",$("#fullBG").remove());cancel_btn=d("cancel_btn");null!==cancel_btn&&check_parent_by_id(cancel_btn,"overlay")&&(cancel_btn.style.visibility=el.style.visibility)}
function check_parent_by_id(a,b,c){"undefined"===typeof c&&(c=0);return"undefined"===typeof a||null===a.parentNode||10<c?!1:a.parentNode.id==b?!0:check_parent_by_id(a.parentNode,b,++c)}
function getUrlParameters(a,b,c){"undefined"===typeof b&&(b="");"undefined"===typeof c&&(c=!0);var e=(b.length?b:window.location.search).split("?")[1];b=!0;if(e)parArr=e.split("&");else return!1;for(e=0;e<parArr.length;e++){parr=parArr[e].split("=");if(parr[0]==a)return c?decodeURIComponent(parr[1]):parr[1];b=!1}if(!b)return!1}function isIE(){var a=navigator.userAgent.toLowerCase();return-1!=a.indexOf("msie")?parseInt(a.split("msie")[1]):!1}
function getNewBrowser(){document.write('<div style="padding:24px;">Сайт не может работать в браузере Internet Explorer ниже 9-й версии,<br/>\r\n\t\t\t\tобновите его или установите альтернативу:\r\n\t\t\t\t<ul><li><a href="https://www.google.com/chrome/browser/">Chrome<a>\r\n\t\t\t\t<li><a href="https://www.mozilla.org/ru/firefox/new">Firefox<a>\r\n\t\t\t\t<li><a href="http://www.opera.com/ru">Opera<a></ul></div>');document.execCommand("Stop")}
function togglePass(a){a=a||"pass";var b="label_for_{0}".f(a);a=d(a);var c=d(b),e="text"===a.type?"показать пароль":"скрыть пароль";a.type="text"===a.type?"password":"text";$("#"+b).length&&(c.innerHTML=e)}function clearHighLight(a){$(void 0===a?"body":a).find(".highlight").each(function(){$(this).removeClass("highlight")})}
var utils={oVal:function(a,b,c){return(c=c||!1)?c.hasOwnProperty(a)?c[a]:b:b},isExpression:function(a){return/[\-\+\*\/]+/g.exec(a)&&"-"!==a[0]},expressionEval:function(a){a=a.replace(/,/g,".");a=a.replace(/(?:[\0-\),:-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])/ig,"");try{return a&&Math.round(100*eval(a))/100}catch(b){return!1}},genId:function(a){return(a||"").toString()+Math.random().toString().split(".")[1]},clickByKey:function(a){a=
window.event||a;var b=a.keyCode?a.keyCode:a.which?a.which:null,c=[];$.each($(".hot-key"),function(e,f){if($(f).is(":visible")&&"hidden"!==$(f).css("visibility")&&"disabled"!==$(f).attr("disabled")){var l=$(f).data("hot-key");if(l){var n=l.key;utils.oVal("ctrl",!1,l)&&!a.ctrlKey||n!==b||c.push($(f))}}});if(c.length){var e=(1<c.length?c.sort(function(a,b){return a.zIndex()===b.zIndex()?0:a.zIndex()>b.zIndex()?-1:1}):c)[0],f=$(".modal").length;!e.parents(".modal").length&&f||e.click()}},flattenObject:function(a){var b=
[];$.each(a,function(a,e){$.isArray(e)?Array.prototype.push.apply(b,e):b.push(e)});return b},makeColor:function(a,b){1>b&&(b=1);return utils.HSLToRGB(660/b*a%360,70,50)},HSLToRGB:function(a,b,c){c/=100;b=b/100*(1-Math.abs(2*c-1));var e=b*(1-Math.abs(a/60%2-1));c-=b/2;var f=0,g=0,k=0;0<=a&&60>a?(f=b,g=e,k=0):60<=a&&120>a?(f=e,g=b,k=0):120<=a&&180>a?(f=0,g=b,k=e):180<=a&&240>a?(f=0,g=e,k=b):240<=a&&300>a?(f=e,g=0,k=b):300<=a&&360>a&&(f=b,g=0,k=e);f=Math.round(255*(f+c));g=Math.round(255*(g+c));k=Math.round(255*
(k+c));return"rgb("+f+","+g+","+k+")"},scrollToElement:function(a,b,c){b="undefined"!=typeof b?b:1E3;c="undefined"!=typeof c?c:0;element=$(a);offset=element.offset();offsetTop=offset.top+c;$("html, body").animate({scrollTop:offsetTop},b)},lzw_encode:function(a){var b={};a=(a+"").split("");for(var c=[],e,f=a[0],g=256,k=1;k<a.length;k++)e=a[k],null!=b[f+e]?f+=e:(c.push(1<f.length?b[f]:f.charCodeAt(0)),b[f+e]=g,g++,f=e);c.push(1<f.length?b[f]:f.charCodeAt(0));for(k=0;k<c.length;k++)c[k]=String.fromCharCode(c[k]);
return c.join("")},lzw_decode:function(a){var b={};a=(a+"").split("");for(var c=a[0],e=c,f=[c],g=256,k,l=1;l<a.length;l++)k=a[l].charCodeAt(0),k=256>k?a[l]:b[k]?b[k]:e+c,f.push(k),c=k.charAt(0),b[g]=e+c,g++,e=k;return f.join("")},copyToClipboard:function(a){var b=document.createElement("textarea");b.value=a;b.setAttribute("readonly","");b.style.position="absolute";b.style.left="-9999px";document.body.appendChild(b);a=0<document.getSelection().rangeCount?document.getSelection().getRangeAt(0):!1;b.select();
document.execCommand("copy");document.body.removeChild(b);a&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(a))}},keys={esc:27,enter:13,left:37,right:39,up:38,down:40,del:46,insert:45,home:36},dateHelper={weekends:["вск","сбт"],defaultDateUIFormat:"dd-M-y",defaultDateFormat:"dd.mm.yy",mysqlFormat:"yy-mm-dd",mysqlToDefault:function(a){return $.datepicker.formatDate(dateHelper.defaultDateFormat,$.datepicker.parseDate(dateHelper.mysqlFormat,a)).toString()},dateToDefault:function(a){return dateHelper.mysqlToDefault(dateHelper.mysqlFromDate(a))},
mysqlFromPicker:function(a){return $.datepicker.formatDate(dateHelper.mysqlFormat,a.datepicker("getDate"))},mysqlFromDate:function(a){return $.datepicker.formatDate(dateHelper.mysqlFormat,a)},mysqlToPicker:function(a,b){a.datepicker("setDate",$.datepicker.parseDate("yy-mm-dd",b));a.change()},dayOfWeek:function(a){if(!$(a).length)return"";a=a.datepicker("getDate").getDay();return $.datepicker._defaults.dayNamesMin[a]||""},dayChange:function(a,b){if(a.length){var c;0>b&&(c=a.datepicker("getDate"),a.datepicker("setDate",
new Date(c-Math.abs(b))));0<b&&(c=$.datepicker.parseDate(dateHelper.defaultDateUIFormat,a[0].value),c.setDate(c.getDate()+b),a.datepicker("setDate",c));a.change()}},mysqlToDate:function(a){return $.datepicker.parseDate("yy-mm-dd",a)},isWeekend:function(a){return-1!==[0,6].indexOf(a.getDay())},monthName:function(a){return $.datepicker.regional.ru.monthNames[a]}};var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};$.fn.measure=function(a){var b=$(this).clone(!1);b.css({visibility:"hidden",position:"absolute"});b.appendTo("body");a=a.apply(b);b.remove();return a};$.fn.outerHtml=function(){return $(this)[0].outerHTML};$.extend(jQuery.expr[":"],{focus:"a == document.activeElement"});$.fn.a=$.fn.append;
$.fn.ato=$.fn.appendTo;$.fn.doUnselectable=function(){return $(this).addClass("unselectable")};function datepickerInit(a,b){$(a).datepicker({changeMonth:!0,changeYear:!0,dateFormat:dateHelper.defaultDateUIFormat,showButtonPanel:!0,showOtherMonths:!0,selectOtherMonths:!0});b=b?$.datepicker.parseDate("dd.mm.yy",b):new Date;return $(a).datepicker("setDate",b)}
function checkEmail(a){a=a||{};var b=a.value||"",c=a.emailField||!1,e=a.excludeUser||!1,f=a.isNotExistsError||!1,g=a.errorIfActive||!1,k=a.callback||!1;if(!b){if(0===c.length)return;b=c.val()}if(c.data("old")!==c.val())return ui.ajaxLoader(c),$.ajax({type:"POST",dataType:"json",url:"/?action=check.email",data:{"email--email":b,"isNotExistsError--bool":f,"errorIfActive--bool":g,"excludeUser--bool":e},success:function(a){var b=$("#check-email");0<b.length&&(a.error?(showValidation(a.validation,{type:"tooltip",
position:"left"}),b.removeClass("img-cir-green"),b.addClass("img-cir-red"),c.data("old","")):(cleanValidation(),b.removeClass("img-cir-red"),b.addClass("img-cir-green"),c.data("old",c.val())));k&&k(a)}})}function checkBoxField(a){a=a||{};var b=a.id||"",c=a.checked||!1,e=a.change||!1;return h.span().a(h.input({c:"css-checkbox",id:b,name:b+"--checkbox",type:"checkbox",checked:c}).change(function(){e&&e(this)}),h.label({"for":b,c:"checkbox-label"}))}
function cleanValidation(a){a=a||{};var b=a.exclude||[];(a=a.id||null)?(a=$('[id^="validation--{0}"]'.f(a)),0<a.length&&a.remove()):$('[id^="validation--"]').each(function(a,e){var f=$(this),g=!1;$(b).each(function(){$("#validation--"+this).html()===f.html()&&(g=!0)});g||e.remove()})}
function showValidation(a,b){b=b||{};var c=b.position||"afterLabel",e=b.type||!1,f=b.messageObject||"",g,k=b.fontSize||!1,l=!1;cleanValidation({exclude:b.exclude||[],id:b.id||null});$(a).each(function(a,b){var m=$("#"+b.field),q=html.span({style:"color:red;",html:b.text});k&&q.css("font-size",k);var r="validation--"+b.field;if(e&&"tooltip"===e){var t={position:"absolute",top:"-6px",border:"1px solid rgb(255, 7, 7)",backgroundColor:"rgb(255, 101, 101)",padding:"5px",whiteSpace:"nowrap"};q.html(q.html()+
"&nbsp;&#9658;").css({color:"#fff"});"right"===c&&(t.left=m.width()+7+"px");g=html.div({id:r}).append(q).css(t);"left"===c&&(t.left=-g.measure(function(){return this.width()})-18+"px",g.css(t));m.after(g);l||m.focus()}else g=html.span({id:r}).append(q),"afterLabel"===c&&(q.before("&nbsp;"),$("label[for="+b.field+"]:first").append(g)),"afterObject"===c&&f.after(g.append(html.br(),g)),"afterField"===c&&m.after(g.append(html.br(),g));l||(l=!0)})}
function addButton(a){a=a||{};var b=a.title||"Добавить",c=a.style||"margin-right: 6px; padding: 4px;",e=a.c||"ui",f=a.click||!1;delete a.click;return h.a({title:b,style:c,c:e+" vmiddle hand"}).a(field.button(utils.genId("add-button-"),$.extend(a,{c:"vmiddle img img-plus",hotKey:{key:keys.insert,ctrl:!0}}))).click(function(){f&&f()})}
var field={text:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c=b.value||"",e=b.blur||!1,f=b.width||168,g=b.height||28,k=b.buttons||[],l=k.length,n=b.type||"string",p=b.input_type||"text",m=b.inputmode||"text",q=b.pattern||!1,r=b.step||!1,t=b.data||{},u=18*l,w=b.placeholder||"",v=utils.oVal("autocomplete","on",b),b=utils.oVal("cssClass","on",b),x,y=h.span({id:"{0}-span".f(a),style:"position: relative"}),c={type:p,id:a,name:"{0}--{1}".f(a,n),value:c,style:"width: {0}px;height: {1}px;padding-right: {2}px;".f(f,
g,u),placeholder:w,c:b};q&&(c.pattern=q);r&&(c.step=r);m&&(c.inputmode=m);y.a(x=h.input(c).blur(function(){e&&e(x)}).data(t).attr("autocomplete",v));y.input=function(){return x};0<l&&$(k).each(function(a,b){var c=h.div({c:"vtop img "+b.img,style:"position:absolute;top:0;height:16px;width:15px;margin:0 3px 0 3px;"+b.style,id:b.id,title:b.title}).css({width:15,right:15*a+3*a}).click(function(){b.click&&b.click()});y.a(c)});return y},period:function(a,b){b=b||{};var c=b.oVal("from",""),e=b.oVal("to",
""),f=b.oVal("clearButton",!1),g=html.div({id:a}),k=field.date(a+"-from",{placeholder:"Начало",value:c,clearButton:f}),l=field.date(a+"-to",{placeholder:"Конец",value:e,clearButton:f});k.find(".date-input").datepicker("option","onClose",function(a){l.find(".date-input").datepicker("option","minDate",a)});l.find(".date-input").datepicker("option","onClose",function(a){k.find(".date-input").datepicker("option","maxDate",a)});c=g.a(h.nobr().a(k,h.span({c:"large"}).html("&nbsp;&mdash;&nbsp;"),l));c.from=
function(){return k};c.to=function(){return l};return c},sort:function(a,b){var c=utils.oVal("selIndex",0,b);b.id=a;b.title="сортировка";b.c="inline";return ui.buttons([{value:"выкл.",selected:0===c},{value:"&nbsp;&darr;&nbsp;",selected:1===c},{value:"&nbsp;&uarr;&nbsp;",selected:2===c}],b)},sortToTitles:function(a,b,c){var e=a.children(".sel").index(),f=0;delete b.sort;0!==e&&($.each(c.titles,function(){this.hasOwnProperty("sort")&&this.sort.index>f&&(f=this.sort.index)}),b.sort={name:a.attr("id"),
direction:e,index:f+1})},list:function(a,b,c){var e=h.div({id:a}),f=c.oVal("cssClass",""),g=c.oVal("nameField","value"),k=c.oVal("filter",!1),l=c.oVal("showCheckAll",!1),n=c.oVal("showBoxes",!0),p=c.oVal("truncateWidth",!1),m=c.oVal("renderItem",!1);c=c.oVal("checkAll",!1);e.addClass(f);e.boxes=function(a){a=a||!1;var b=e.find('input[type="checkbox"]');if(!a)return b;var c=[];b.each(function(b,e){var f=a(e);f&&c.push(f)});return c};m=m||function(b,c){var f=a+"-chb-"+b,k=h.input({type:"checkbox",id:f,
c:"vmiddle"}).attr("data-item-id",c.id).attr("data-item-value",c[g]);"check-all"===c.id?k.click(function(){e.find('input[type="checkbox"]').prop("checked",$(this).prop("checked"))}):l&&k.click(function(){var a=e.boxes(function(a){return"check-all"===$(a).data("itemId")?!1:a}),b=e.boxes(function(a){return"check-all"!==$(a).data("itemId")?!1:a});$(b).prop("checked",0===$(a).not(":checked").length)});var m=c[g];p&&(m=m.toString().truncate({oneWord:!0,maxWidth:p}));return h.div({style:"padding: 3px 0;"}).a(n?
k:"",h.label({"for":f,c:"ui vmiddle",style:"margin-left: 7px"}).html(m))};k&&(b=$.grep(b,k));l&&(f={id:"check-all"},f[g]="Все",e.append(m("check-all",f)));$.each(b,function(a){e.append(m(a,this))});c&&e.find('input[type="checkbox"]').prop("checked",!0);e.notCheckOrCheckAll=function(){var a=e.boxes();return 0===a.not(":checked").length||!a.is(":checked")};e.selectedIds=function(){return e.boxes(function(a){if(!a.checked)return!1;a=$(a).data("itemId");return"check-all"===a?!1:a})};e.selectedValues=
function(){return e.boxes(function(a){if(!a.checked)return!1;a=$(a).data("itemValue");return"check-all"===a?!1:a})};e.check=function(a){e.boxes().each(function(b,c){$(c).prop("checked",!1);-1!==a.indexOf($(c).data("itemId"))&&$(c).prop("checked",!0)})};return e},interval:function(a){var b=html.div({id:a}),c=field.amount(a+"-from",{placeholder:"От",value:"",showCurrency:!1}),e=field.amount(a+"-to",{placeholder:"До",value:"",showCurrency:!1});a=b.append(html.div().append(c).css("padding-bottom","4px"),
e);a.from=function(){return c};a.to=function(){return e};return a},amountEvalVal:function(a){var b=$(a).val();if(!b)return!1;b=utils.expressionEval(b);if(!1===b)return popup.error("Неверное математическое выражение",{afterClose:function(){a.focus()}}),!1;a.val(b)},amountCalcInit:function(a){var b=a.find("input:first");b.data("isInit")||(b.calculator({showOn:"button",buttonImageOnly:!0,constrainInput:!1,showFormula:!0,showAnim:"slideDown",duration:"fast",onClose:function(){b.change()}}),b.calculator("option",
{precision:2}),b.data("isInit",!0))},amount:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};b.autocomplete="off";var c=utils.oVal("showCurrency",!0,b),e=utils.oVal("showEqual",!1,b),f=utils.oVal("showCalc",!0,b),g=utils.oVal("excludeCurrencies",[],b),k=utils.oVal("currencyId",user.def.currencyId,b),l=utils.oVal("cssClass","",b),n=utils.oVal("tabIndex","",b),p=b.oVal("type","amount"),m=void 0,q=b.oVal("scrolling",!1),r=void 0;b.buttons=[];b.type=p;e&&b.buttons.push({id:a+
"-equal",value:"=",title:"В поле &laquo;сумма&raquo; можно вводить арифметические выражения. Например, &laquo;56*3+200&raquo; или &laquo;126/3&raquo;. Ответ посчитается после нажатия на &laquo;=&raquo; или автоматически, перед сохранением.",click:function(){field.amountEvalVal(m)}});f&&b.buttons.push({id:a+"-calc",img:"img-calc",title:'Вычислить значение, если напечатано выражение (например, "100 + 250 + 300") или вызвать калькулятор',click:function(){utils.isExpression(r.val())?field.amountEvalVal(r):
r.calculator("none"===$(".calculator-popup").css("display")?"show":"hide")}});b.blur=function(a){field.amountEvalVal(a)};b.cssClass=l+" amount-input";b.input_type="text";ui.isMobile()&&(b.inputmode="decimal",b.step="any",b.blur=function(a){});m=field.text(a,b);r=m.find("input:first");n&&r.attr("tab-index",n);c&&(b=currency.select({id:"currencyId",defaultId:k,excludeCurrencies:g,showAdd:!0,tabIndex:n?n+1:!1}).css({marginLeft:"2px",width:"51px"}),m=h.div().a(m,b));f&&field.amountCalcInit(m);if(q){q.oVal("wrapperSelector");
var t=q.oVal("min"),u=q.oVal("max"),w=q.oVal("step",1),v=void 0,x=void 0,y=q.oVal("up",function(){var a=parseFloat(r.val());a<u&&r.val(a+w)}),z=q.oVal("down",function(){var a=parseFloat(r.val());a>t&&r.val(a-w)}),B=q.oVal("onChange",function(){}),A=function(){var a=parseFloat(r.val());a<=t?ui.disable(x):ui.enable(x);a>=u?ui.disable(v):ui.enable(v)},f=void 0;m.a(f=h.div({id:a+"-scroll-wrapper"}).css({display:"inline-block",verticalAlign:"bottom"}));r.css({height:"39px"});f.append(h.div().css({display:"table"}).a(h.div().css({display:"table-row",
lineHeight:0}).a(v=h.button({html:"&#9650;",type:"button","class":"unselectable"}).css({display:"table-cell",borderWidth:"1px 1px 0 0",height:"20px"}).click(function(){y(r);B(r);A()})),h.div().css({display:"table-row",lineHeight:0}).a(x=h.button({html:"&#9660;",type:"button","class":"unselectable"}).css({display:"table-cell",borderWidth:"0 1px 1px 0",height:"19px"}).click(function(){z(r);B(r);A()}))));A()}m.input=function(){return m.find("input:first")};return m},date:function(a,b){var c=b.oVal("placeholder",
!1),e=b.oVal("value",!1),f=b.oVal("sqlValue",!1),g=b.oVal("showDayOfWeek",!0),k=b.oVal("afterSelect",!1),l=b.oVal("showNav",!1),n=b.oVal("navKey",!1),p=b.oVal("tabIndex",!1),m=b.oVal("clearButton",!0),q=h.input({type:"text",c:"date-input unselectable",id:a,style:"width:109px;height:28px;text-align:center;"+(g?"padding:0 27px 0 0;":""),placeholder:c||"",readonly:""}),r=h.input({type:"text",c:"day-of-week unselectable",id:"day_of_week_for_"+a,style:"margin-left:-26px;padding:0px;width:26px;text-align:center;",
tabIndex:-1}).prop("readonly",!0),t=h.input({type:"hidden",name:a+"--date",id:a+"--date",c:"sql-date"}),u=c="";l&&(c=h.span({c:"large hand unselectable"+(n?" hot-key":"")}).a("&larr;&nbsp;").click(function(){dateHelper.dayChange(q,-1)}),u=h.span({c:"large hand unselectable"+(n?" hot-key":"")}).a("&nbsp;&rarr;").click(function(){dateHelper.dayChange(q,1)}),n&&(c.data("hot-key",{key:keys.left,ctrl:!0}),u.data("hot-key",{key:keys.right,ctrl:!0})));p&&q.attr("tab-index",p);l=h.nobr({c:"date-field"}).a(c,
q,g?r:"",u,t);if(!1===e||0!==e.length)e="now"!==e&&e?$.datepicker.parseDate("dd.mm.yy",e):new Date;var w=q.datepicker({changeMonth:!0,changeYear:!0,dateFormat:dateHelper.defaultDateUIFormat,showButtonPanel:!0,showClearButton:m,showOtherMonths:!0,selectOtherMonths:!0});k&&q.datepicker("option","onSelect",function(){k()});f?dateHelper.mysqlToPicker(w,f):w.datepicker("setDate",e);e=function(){if(0!==q.val().length){var a=dateHelper.dayOfWeek(q);r.removeClass("hightlight").removeClass("red");a!==$.datepicker._defaults.dayNamesMin[0]&&
a!==$.datepicker._defaults.dayNamesMin[6]||r.addClass("red");r.val(a)}else r.val("");t.val(q.val().length?dateHelper.mysqlFromPicker(q):"");k&&k()};g&&e();q.change(e);q.datepicker("option","onClose",e);l.mysqlDate=function(){return t.val()};l.picker=function(){return w};q.data({dateField:l});return l},textareaResize:function(a){var b=a.val(),c=parseInt(a.attr("cols")),e=0;$(b.split("\n")).each(function(a,b){e+=Math.ceil((b.length||1)/c)});a.attr("rows")!==e+1&&a.attr("rows",e+1)},textarea:function(a,
b){var c=utils.oVal("cols",20,b),e=utils.oVal("rows",3,b),f=utils.oVal("value","",b),g=utils.oVal("style","",b),k=utils.oVal("isAutoHeight",!1,b),l=utils.oVal("placeholder","",b),n=b.oVal("onChange",!1),p=html.div({id:a+"--span"}),m=h.textarea({id:a,name:a+"--string",c:"textarea-input",rows:e,cols:c,placeholder:l,html:f,style:g}).change(function(a){n&&n(a)});p.append(m);k&&(m.css({"overflow-y":"hidden"}),m.keyup(function(){field.textareaResize(m)}));p.input=function(){return m};return p},select:function(a,
b){var c=html.div({id:a+"--div"}),e=b.oVal("cssClass",""),f=b.oVal("items",[]),g=b.oVal("selOptions",!1),k=b.oVal("selClass",""),l=b.oVal("width",""),n=b.oVal("unselectVal",!1),p=b.oVal("type","id"),m=b.oVal("isCloud",!1),q=b.oVal("cloudOptions",{}),r=b.oVal("isArhiveShow",!1),t=b.oVal("valueField",!1),u=b.oVal("tabIndex",!1),w=b.oVal("change",function(){}),v=b.oVal("addNew",function(){}),x=b.oVal("defId",!1),y=h.select({id:a,name:a+"--"+p,c:k}).change(function(){w();-1!==y.val().toString().indexOf("new")&&
v()});u&&y.attr("tab-index",u);l&&y.css({width:l});var z=null;c.addClass(e);n&&y.append(html.option({value:"-1",text:n}));g?$.each(g,function(a,b){var c=b.data("item"),c="undefined"===typeof c?"0":c.arhive;(r||"1"!==c)&&y.append(b)}):$.each(f,function(a,b){var c=b.id,e=t?b[t]:b.value,f=utils.oVal("arhive",0,b);if(r||"1"!==f)e=html.option({value:c,text:e}).data({item:b}),x&&c===x&&e.attr("selected",""),y.append(e)});c.append(y);m&&(q.items=f,q.valueField=t,z=ui.cloud(a+"--cloud",q),c.append(z));c.cloud=
function(){return z};c.val=function(a){a&&y.val(a);return y.val()};return c},button:function(a,b){var c=b.oVal("c",""),e=b.oVal("html",""),f=b.oVal("type","button"),g=b.oVal("hotKey",!1),k=b.oVal("tabIndex",!1),l=b.oVal("hint",!1),n=b.oVal("data",{}),p=b.oVal("click",function(){}),m=h.button({type:f,id:a,c:c,data:n,html:e,click:p});k&&m.attr("tab-index",k);g&&(m.addClass("hot-key"),m.data("hot-key",g));l&&(m=h.div().a(m,h.br(),h.span({c:"lightGray xsmall"}).html(l)));m.disable=function(){ui.disable(m.find("button"))};
m.enable=function(){ui.enable(m.find("button"))};return m},selectSetEnable:function(a){$.each(a.find("option"),function(){$(this).prop("disabled",!1)})},selectVal:function(a,b){0<a.find("option").filter(function(){return this.value===b}).length&&a.val(b)},hidden:function(a,b){var c={id:a,type:"hidden"};b.hasOwnProperty("type")&&(b.name=a+"--"+b.type,delete b.type);return html.input($.extend(c,b))},checkbox:function(a,b){var c=b.oVal("text",""),e=b.oVal("checked",!1),f=b.oVal("click",function(){}),
c=html.label({"for":a,html:c}).css({"padding-left":"4px"}),g=h.nobr().append(h.input({type:"checkbox",id:a,c:"vmiddle",checked:e}).change(function(){f()}),c);g.checked=function(){return 0!==g.find("#"+a).filter(":checked").length};g.box=function(){return g.find("#"+a)};return g},comment:function(a,b){var c={cols:25,rows:2,placeholder:"Комментарий",style:"width:"+b.oVal("width",219)+"px;",isAutoHeight:!0};return field.textarea(a,$.extend(c,b))},email:function(){var a=0<arguments.length&&void 0!==arguments[0]?
arguments[0]:{},b=a.id||"email",c=a.value||"",e=a.check||!1,f=a.excludeUser||!1,g=a.isNotExistsError||!1,k=a.placeholder||"",l=a.errorOn||!1,n=a.errorIfActive||!1,p=a.hasOwnProperty("isCheckOnBlur")?a.isCheckOnBlur:!0,m=function(){e?e():checkEmail({emailField:$("#"+b),excludeUser:f,isNotExistsError:g,errorIfActive:n})};return field.text(b,{value:c,width:200,type:"email",blur:function(){p&&m()},data:{old:c?c:"undefined"},placeholder:k,buttons:[{id:"check-email",img:"img-cir-{0}".f(l?"red":"green"),
title:"проверить",click:m}]})},progress:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c=h.progress({id:a,value:b.value,max:b.max}),e=a+"-current-value-label";b.data&&c.data(b.data);c.labelObj=null;c.label=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";!c.labelObj&&c.before(c.labelObj=h.div({id:e,html:a,css:{fontSize:"1em",paddingTop:"7px",position:"absolute",left:0,right:0}}));return a?c.labelObj.html(a):labelObj};var f=function(){c.label("function"===
typeof b.label?b.label(c):b.label)};b.label&&setTimeout(f,100);c.val=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";if(!a)return c.attr("value");c.prop("value",a);f();return a};c.data("progress",c);return c}},tableFilter={buttons:function(){return popup.buttons([{value:"Применить",type:"submit"}]).css({paddingTop:"16px"})},submit:function(a,b,c,e){a&&field.sortToTitles(a,b,c);c.paginationReset();a=e.find('input[type="submit"]');ui.ajaxLoader(a,{position:"left"});ui.disable(a);
$.when(c.load({isResultWithCount:!0})).then(function(){c.show();$(".linked-popup").remove()});return!1},date:function(a,b){b.clearButton=b.oVal("clearButton",!0);var c=utils.oVal("table",!1,b),e=utils.oVal("title",!1,b),f=e.hasOwnProperty("sort")?e.sort.direction:0,g=field.sort(a+"-sort",{selIndex:f}),f=field.period(a,b),k=f.find(".date-input:first"),l=f.find(".date-input:last"),n=f.find(".sql-date:first"),p=f.find(".sql-date:last"),m;m=h.form({submit:function(){if(!c)return!1;k.val()||l.val()?e.filterVal=
{from:{name:n.attr("name"),value:n.val()},to:{name:p.attr("name"),value:p.val()}}:delete e.filterVal;return tableFilter.submit(g,e,c,m)}}).a(f.css("padding","14px"),html.div({c:"hcenter nobr"}).a(g),tableFilter.buttons());e.hasOwnProperty("filterVal")&&(f=e.filterVal,dateHelper.mysqlToPicker(k,f.from.value),dateHelper.mysqlToPicker(l,f.to.value));return m},word:function(a,b){var c=utils.oVal("table",!1,b),e=utils.oVal("title",!1,b),f=utils.oVal("list",!1,e.filter),g=utils.oVal("nameField",!1,e.filter),
k=e.hasOwnProperty("sort")?e.sort.direction:0,l=field.sort(a+"-sort",{selIndex:k}),n=field.list(a,f,{nameField:g,showCheckAll:!0,filter:function(a){return"0"===a.arhive}}),p;p=h.form({submit:function(){if(!c)return!1;var b=n.boxes();if(0!==b.not(":checked").length&&b.is(":checked")){var f=[];b.filter(":checked").each(function(){var a=$(this).data("item-id");a&&f.push(a)});e.filterVal={word:{name:a,value:f}}}else delete e.filterVal;return tableFilter.submit(l,e,c,p)}}).a(n.css("padding","14px").css("width",
"215px"),html.div({c:"hcenter nobr"}).append(l),tableFilter.buttons());e.hasOwnProperty("filterVal")?$.each(e.filterVal.word.value,function(){p.find('input[type="checkbox"][data-item-id="{0}"]'.f(this)).prop("checked",!0)}):p.find('input[type="checkbox"][data-item-id="check-all"]').click();return p},amount:function(a,b){var c=utils.oVal("table",!1,b),e=utils.oVal("title",!1,b),f=e.hasOwnProperty("sort")?e.sort.direction:0,g=field.sort(a+"-sort",{selIndex:f}),f=field.interval(a,b),k=f.find(".amount-input:first"),
l=f.find(".amount-input:last"),n=a+"-currency",p=field.list(n,user.currency,{showCheckAll:!0,nameField:"curName",cssClass:"dcenter hleft",filter:function(a){return"0"===a.arhive}}),m;m=h.form({submit:function(){if(!c)return!1;var a=p.boxes();if(k.val()||l.val()||0!==a.not(":checked").length&&a.is(":checked")){if(e.filterVal={from:{name:k.attr("name"),value:k.val()},to:{name:l.attr("name"),value:l.val()}},0!==a.not(":checked").length&&a.is(":checked")){var b=[];a.filter(":checked").each(function(){var a=
$(this).data("item-id");a&&b.push(a)});e.filterVal.word={name:n,value:b}}}else delete e.filterVal;return tableFilter.submit(g,e,c,m)}}).a(f.css({padding:"14px"}),h.div({c:"hleft"}).a(p).css({"padding-bottom":"14px","padding-left":"14px"}),h.div({c:"hcenter nobr"}).a(g),tableFilter.buttons());e.hasOwnProperty("filterVal")?(f=e.filterVal,k.val(f.from.value),l.val(f.to.value),f.hasOwnProperty("word")?$.each(f.word.value,function(){m.find('input[type="checkbox"][data-item-id="{0}"]'.f(this)).prop("checked",
!0)}):m.find('input[type="checkbox"][data-item-id="check-all"]').click()):m.find('input[type="checkbox"][data-item-id="check-all"]').click();return m},recordType:function(a,b){var c=b.oVal("table",!1),e=b.oVal("title",!1),f,g={padding:"8px",margin:"8px"},k={cssClass:"hleft list-small",showCheckAll:!0,checkAll:!0,truncateWidth:100},l=$.extend({nameField:"accountName",filter:function(a){return"0"===a.arhive}},k),n=function(a,b){return"1"!==b.arhive},p=field.list(a+"-exp-cats",category.categories(n).exp,
k).css(g),m=field.checkbox(a+"-exp",{text:"Траты",checked:!0,click:function(){p.slideToggle()}}),q=field.list(a+"-inc-cats",category.categories(n).inc,k).css(g),r=field.checkbox(a+"-inc",{text:"Доходы",checked:!0,click:function(){q.slideToggle()}}),t,u=field.checkbox(a+"-move",{text:"Перемещения",checked:!0,click:function(){t.slideToggle()}}),w=field.list(a+"-acc1",user.account,l).css(g),v=field.list(a+"-acc2",user.account,l).css(g),x=field.checkbox(a+"-note",{text:"Заметки",checked:!0}),g={width:"175px"},
k={"padding-top":"16px"},l={"padding-top":"8px"};f=h.form({submit:function(){e.filterVal=e.filterVal||{};var a=e.filterVal,b=[{key:"exp",name:"exp--bool",enable:m.checked(),lists:[{list:p,key:"expCats"}]},{key:"inc",name:"inc--bool",enable:r.checked(),lists:[{list:q,key:"incCats"}]},{key:"move",name:"move--bool",enable:u.checked(),lists:[{list:w,key:"acc1"},{list:v,key:"acc2"}]},{key:"note",name:"note--bool",enable:x.checked(),lists:[]}];$(b).each(function(b,c){c.enable?(delete a[c.key],$(c.lists).each(function(b,
c){c.list.notCheckOrCheckAll()?delete a[c.key]:a[c.key]={name:c.key,value:c.list.selectedIds()}})):a[c.key]={name:c.name,value:!1}});tableFilter.submit(null,e,c,f);return!1}}).a(h.div({c:"dcenter hcenter"}).a(h.div({c:"vtop dcenter hcenter"}).a(m,p).css(g),h.div({c:"vtop dcenter hcenter"}).a(r,q).css(g)).css(k),h.div({c:"vtop hcenter cboth"}).a(u).css(l),t=h.div({c:"dcenter hcenter"}).a(h.div({c:"vtop dcenter hcenter"}).a("Со счёта",w).css(g),h.div({c:"vtop dcenter hcenter"}).a("На счёт",v).css(g)).css(k),
h.div({c:"vtop hcenter cboth"}).a(x).css(l),tableFilter.buttons());e.hasOwnProperty("filterVal")&&(g=e.filterVal,g.exp&&!g.exp.value&&m.box().attr("checked",!1)&&p.hide(),g.expCats&&p.check(g.expCats.value),g.inc&&!g.inc.value&&r.box().attr("checked",!1)&&q.hide(),g.incCats&&q.check(g.incCats.value),g.move&&!g.move.value&&u.box().attr("checked",!1)&&t.hide(),g.acc1&&w.check(g.acc1.value),g.acc2&&v.check(g.acc2.value),g.note&&!g.note.value&&x.box().attr("checked",!1));return f},statCategory:function(a,
b){var c=b.oVal("table",!1);b.oVal("title",!1);var e;e={padding:"8px",margin:"8px"};var f={cssClass:"hleft list-small-long",showCheckAll:!0,checkAll:!0,truncateWidth:100},g=function(a,b){return"1"!==b.arhive},k=field.list(a+"-exp-cats",category.categories(g).exp,f).css(e),l=field.checkbox(a+"-exp",{text:"Расходные",checked:!0,click:function(){k.slideToggle()}}),n=field.list(a+"-inc-cats",category.categories(g).inc,f).css(e),p=field.checkbox(a+"-inc",{text:"Доходные",checked:!0,click:function(){n.slideToggle()}});
e={width:"175px"};e=h.form({submit:function(){var a=[{key:"exp",name:"exp--bool",enable:l.checked(),lists:[{list:k,key:"expCats"}]},{key:"inc",name:"inc--bool",enable:p.checked(),lists:[{list:n,key:"incCats"}]}],b={};$(a).each(function(a,c){c.enable?$(c.lists).each(function(a,c){c.list.notCheckOrCheckAll()||(b[c.key]={name:c.key,value:c.list.selectedIds()})}):b[c.key]={name:c.name,value:!1}});c.filters.category=b;c.items=[];$(".linked-popup").remove();c.show();return!1}}).a(h.div({c:"dcenter hcenter"}).a(h.div({c:"vtop dcenter hcenter"}).a(l,
k).css(e),h.div({c:"vtop dcenter hcenter"}).a(p,n).css(e)).css({"padding-top":"8px"}),tableFilter.buttons());c.filters.category&&(f=c.filters.category,f.exp&&!f.exp.value&&l.box().attr("checked",!1)&&k.hide(),f.expCats&&k.check(f.expCats.value),f.inc&&!f.inc.value&&p.box().attr("checked",!1)&&n.hide(),f.incCats&&n.check(f.incCats.value));return e},statAmount:function(a,b){var c=utils.oVal("table",!1,b);utils.oVal("title",!1,b);var e=field.interval(a,b),f=e.from(),g=e.to(),k={padding:"8px",margin:"8px"},
l={showCheckAll:!0,checkAll:!0,truncateWidth:100,cssClass:"hleft list-small",filter:function(a){return"0"===a.arhive}},n=field.list(a+"-currency",user.currency,$.extend(l,{nameField:"curName"})).css(k),p=field.list(a+"-account",user.account,$.extend(l,{nameField:"accountName"})).css(k),m=field.text(a+"-comment",{placeholder:"Комментарий",width:333}).css({marginLeft:"-1px"}),k={width:"175px"},e=h.form({submit:function(){var a={};$([{key:"currency",list:n},{key:"account",list:p}]).each(function(b,c){var e=
c.hasOwnProperty("list")?c.list:!1;e&&!e.notCheckOrCheckAll()&&(a[c.key]=e.selectedIds())});f.input().val()&&(a.from=f.input().val());g.input().val()&&(a.to=g.input().val());m.input().val()&&(a.comment=m.input().val());$(".linked-popup").remove();c.filters.amount=a;c.items=[];c.show();return!1}}).a(e.css({padding:"14px"}).addClass("hcenter"),h.div({c:"dcenter hcenter"}).a(h.div({c:"vtop dcenter hcenter"}).a("Счета",p).css(k),h.div({c:"vtop dcenter hcenter"}).a("Валюты",n).css(k),h.div({c:"cboth"}),
h.div({c:"vtop dcenter hcenter"}).a(m)).css({paddingTop:"8px"}),tableFilter.buttons());c.filters.amount&&(k=c.filters.amount,k.currency&&n.check(k.currency),k.account&&p.check(k.account),k.comment&&m.input().val(k.comment),k.from&&f.input().val(k.from),k.to&&g.input().val(k.to));return e}},ui={image:function(a){return h.button({c:"img img-"+a,type:"button"})},cloud:function(a,b){var c=b.oVal("cssClass",""),e=b.oVal("width",300),f=b.oVal("fontMin",13),g=b.oVal("fontMax",26),k=b.oVal("style",""),l=
b.oVal("percentFilter",.01),n=b.oVal("limit",!1),p=b.oVal("click",function(){}),m=b.oVal("items",[]),q=b.oVal("isArhiveShow",!1),r=b.oVal("isShowOne",!0),t=b.oVal("itemRender",!1),u=b.oVal("withBr",!1),w=b.oVal("valueField",!1),v=h.div({id:a,c:"tagcloud "+c,style:k}).css({width:e}),x=g-f,y=1E3,z=0;v.render=function(a){a&&(m=a);v.html("");$.each(m,function(a,b){var c=parseInt(utils.oVal("cnt",0,b));c<y&&(y=c);c>z&&(z=c)});var b=0;$.each(m,function(a,c){var g=utils.oVal("cnt",0,c),k=utils.oVal("arhive",
0,c),m=w?c[w]:c.value,g=g/z,r=0===z?r:(isMobile?8:0)+Math.round(100*(f+g*x))/100;n&&b>=n||!q&&"1"===k||g<l||(k=t?t(m):m.truncate({oneWord:!0,maxWidth:e,fontSize:r+"px"}),v.a(h.a({c:"ui",html:k}).css({"font-size":r+"px"}).click(function(){p(c)})," ",u&&html.br()),b++)});!r&&1===b&&v.html("");return v};return v.render()},animate:function(a,b){var c=utils.oVal("after",!1,b),e=utils.oVal("before",!1,b),f=utils.oVal("animate",!1,b),g=utils.oVal("duration",500,b);e&&e(a);a.animate(f,g,function(){c&&c(a)})},
fadeOutStrict:function(a){ui.fadeOut(a,{after:function(a){$(a).hide()}})},fadeInStrict:function(a){ui.fadeIn(a,{before:function(a){$(a).show()}})},fadeOut:function(a,b){b=b||{};b.animate={opacity:0};b.after=function(){a.css({visibility:"hidden"})};ui.animate(a,b)},fadeIn:function(a,b){b=b||{};b.animate={opacity:1};b.duration=$.fx.speeds._default;ui.animate(a,b);a.css({visibility:"visible"})},fadeToggle:function(a,b){(b=b||"hidden"===a.css("visibility"))?(ui.fadeIn(a),ui.enable(a)):(ui.fadeOut(a),
ui.disable(a))},buttons:function(a,b){b=b||{};a=a||[];if(0!==a.length){var c=b.id||"",e=h.div({id:c,c:"button-group unselectable "+(b.c||""),style:b.style||"",data:b.data||{},title:b.title||"",tabIndex:b.tabIndex||""}),f=function(b){$(a).each(function(a,c){var e=$("#"+c.tabId);0<e.length&&e[0]!==b[0]&&e.hide()})};$(a).each(function(a,b){b.id=b.oVal("id",c+"button"+a);var l=b.oVal("data",{}),n=b.oVal("type","button"),p=b.oVal("notSelected",!1),m=b.oVal("cssClass",""),q=b.oVal("hotKey",!1),r=b.oVal("tabIndex",
!1),l=field.button(b.id,{html:b.value,c:m+(b.selected?" sel":""),type:n,data:l,hotKey:q,tabIndex:r,click:function(){if(!p){if(e.find("#"+b.id).hasClass("sel"))return;e.find(".sel").removeClass("sel");e.find("#"+b.id).addClass("sel")}if(b.hasOwnProperty("tabId")){var a=$("#"+b.tabId);"none"===a.css("display")&&(a.css({opacity:0}).show(),ui.fadeIn(a));f(a)}b.click&&b.click(this)}});e.append(l)});e.selected=function(){return e.find("button.sel")};e.map=function(a){$.each(e.find("button"),function(){a($(this))})};
e.buttons=function(){return e.find("button")};return e}},disable:function(a){a.attr("disabled","disabled")},disableSelect:function(a){a.find("option:not(:selected)").attr("disabled",!0)},disableNotInput:function(a){a.css({filter:"grayscale(100%)",pointerEvents:"none",color:"ccc !important"})},isEnable:function(a){return"disabled"!==a.attr("disabled")},enable:function(a){a.removeAttr("disabled")},prettyDate:function(a,b,c){b=b||"yy-mm-dd";c=c||!1;var e=html.nobr().html($.datepicker.formatDate(dateHelper.defaultDateUIFormat,
$.datepicker.parseDate(b,a)));if(!c)return e;b=$.datepicker.formatDate("D",$.datepicker.parseDate(b,a));if(-1===dateHelper.weekends.indexOf(b))return e;e=$.datepicker.formatDate("dd",$.datepicker.parseDate(dateHelper.mysqlFormat,a));a=$.datepicker.formatDate("-M-y",$.datepicker.parseDate(dateHelper.mysqlFormat,a));return html.span().append(html.nobr().append(html.span({html:e,style:"color:red"}),html.span({html:a})))},prettyDateTd:function(a){return html.td({"class":"date hcenter"}).append(ui.prettyDate(a,
dateHelper.mysqlFormat,!0))},focusAndEndCursor:function(a){a.focus();a[0].selectionStart=a.val().length},showMain:function(){var a=$("#main");a.css({opacity:0});a.addClass("dcenter");ui.fadeIn(a,{duration:$.fx.speeds._default})},clearHighlight:function(a,b){a="body";var c=utils.oVal("cssClass","highlight",b),e="."+c;$(a).find(e).each(function(){$(this).removeClass(c)})},makeFilteredTh:function(a,b,c){var e=c.title||" ",f=c.uiTitle||"",g=c.oVal("visible",!0)?"":"border-bottom-width:0px",k=c.oVal("filter",
!1).oVal("type",!1),l=c.oVal("position","center"),n=k?h.a({c:"ui",id:utils.genId("title-")}).html(e):e,e=h.th({style:g,c:c.c||"",title:f}).a(n,"filterVal"in c&&0<Object.keys(c.filterVal).length&&ui.image("filter").addClass("vbottom"),"sort"in c&&(1===c.sort.direction?h.symbols.downArrow:h.symbols.upArrow));if(k){var p=a.id+"-filter-"+k+"-"+(b+1);n.click(function(){popup.killLinked();popup.linkedShow(tableFilter[k](p,{table:a,title:c}),n,{style:"padding: 5px 0 5px 0;font-weight: bold;",position:l})})}return e.attr("id",
p)},makeTable:function(a){a=a||{};var b=a.titles,c=a.table,e=!1,f,g=h.table({id:a.id,c:a.c,style:a.tableStyle}).a(e=h.thead(),a=h.tbody(),f=h.tfoot()),k=h.tr();"function"===typeof b?b(c,e):($.each(b,function(a,b){k.a(ui.makeFilteredTh(c,a,b))}),e.a(k));g.thead=e;g.tbody=a;g.tfoot=f;c.thead=e;c.tbody=a;c.tfoot=f;return g},renderTableBody:function(a,b,c){var e=a.tbody.first();$.each($.isArray(b)?b:[b],function(){e.append(c(this))})},itemAmount:function(a){var b=h.td({c:"hright",html:h.nobr({c:"amount hright"}).a(ui.prettyMoney(a))}),
c=h.td({html:b.html(),c:"hright"});a.comment&&!a.comment.isEmpty()&&(b.addClass("comment"),b.prop("title",a.comment.nl2br()));return{amount:b,amountWithoutComment:c}},prettyMoney:function(a){var b=0>a.amount,c="",e=(Math.abs(a.amount)+"").formatMoney();if("onlyAmount"===a.type)return b?e.prepend("-"):e;a.currencySymbol=a.currencySymbol||a.symbol;a.positive=a.oVal("positive","0");"0"===e&&h.span().a(h.symbols.shortSpace,a.currencySymbol);c=b?"-":"1"==a.positive?h.span({html:"+",css:{color:"#7a7"}}):
"";return h.span().a(c,e,h.symbols.shortSpace,a.currencySymbol)},prettyAmount:function(a){return ui.prettyMoney({type:"onlyAmount",amount:a})},ajaxLoadersHide:function(a,b,c){var e=c?c.oVal("ajaxId",!1):!1;$("[id*=ajaxLoader]").each(function(){var a=$(this);a.data.hasOwnProperty("ajaxId")?a.data("ajaxId")===e&&a.remove():a.remove()})},ajaxLoader:function(a,b){if(a&&0!==a.length){b=b||{};var c=b.position||"right",e=b.offsetLeft||0,f=b.offsetTop||0,g="ajaxLoader4{0}".f(""===a.attr("id")?a.tagName:a.attr("id")),
k=html.nobr().append(ui.image("loader-pacman").css({"vertical-align":"middle","z-index":999})),l=b.oVal("ajaxId",!1),n=0,p=0;"right"===c&&("absolute"!==a.css("position")&&a.css({position:"relative"}),n=a.outerWidth(!0)+e,p=a.outerHeight(!0)/2-8+f);"left"===c&&(a.css({position:"relative"}),n=-(16+e),p=a.outerHeight(!0)/2-8+f);c=html.div({id:g,css:{position:"in-center"===c?"relative":"absolute",left:n,top:p,backgroundColor:"transparent",zIndex:999}});l&&c.data("ajaxId",l);a.a(c.a(k))}},setHotKey:function(a,
b){a.hasClass("hot-key")||a.addClass("hot-key");a.data("hot-key",b)},isMobile:function(a){function b(){return a.apply(this,arguments)}b.toString=function(){return a.toString()};return b}(function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return null!==a?window._isMobile=a:window._isMobile})},prepareAttrs=function(a){a=a||{};a.hasOwnProperty("c")&&(a["class"]=a.c,delete a.c);return a},html={div:function(a){return $("<div>",prepareAttrs(a))},span:function(a){return $("<span>",
prepareAttrs(a))},ol:function(a){return $("<ol>",prepareAttrs(a))},ul:function(a){return $("<ul>",prepareAttrs(a))},li:function(a){return $("<li>",prepareAttrs(a))},form:function(a){return $("<form>",prepareAttrs(a))},a:function(a){return $("<a>",prepareAttrs(a))},p:function(a){return $("<p>",prepareAttrs(a))},select:function(a){return $("<select>",prepareAttrs(a))},option:function(a){return $("<option>",prepareAttrs(a))},br:function(a){return $("<br>",prepareAttrs(a))},button:function(a){return $("<button>",
prepareAttrs(a))},nobr:function(a){return $("<nobr>",prepareAttrs(a))},input:function(a){return $("<input>",prepareAttrs(a))},img:function(a){return $("<img>",prepareAttrs(a))},small:function(a){return $("<small>",prepareAttrs(a))},label:function(a){return $("<label>",prepareAttrs(a))},th:function(a){return $("<th>",prepareAttrs(a))},tr:function(a){return $("<tr>",prepareAttrs(a))},td:function(a){return $("<td>",prepareAttrs(a))},table:function(a){return $("<table>",prepareAttrs(a))},thead:function(a){return $("<thead>",
prepareAttrs(a))},tfoot:function(a){return $("<tfoot>",prepareAttrs(a))},tbody:function(a){return $("<tbody>",prepareAttrs(a))},textarea:function(a){return $("<textarea>",prepareAttrs(a))},canvas:function(a){return $("<canvas>",prepareAttrs(a))},progress:function(a){return $("<progress>",prepareAttrs(a))},space:function(){return"&nbsp;"},symbols:{space:"&nbsp;",shortSpace:"&thinsp;",upTriangle:"&#9650;",downTriangle:"&#9660;",rightArrow:"&rarr;",leftArrow:"&larr;",upArrow:"&darr;",downArrow:"&uarr;",
hellip:"&hellip;",rub:"₽"}},h=html,popup={killLink:function(a){var b=utils.oVal("click",!1,a);return h.span({c:"ui"}).append(h.button({c:"img img-delete-grey fright",style:"margin: 4px;",type:"button"})).click(function(){b?b():popup.kill()})},show:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c=$("#overlay");b.hasOwnProperty("paddingTop");b.hasOwnProperty("marginTop");var e=b.oVal("onClose",popup.kill),f=b.oVal("afterClose",!1),g=$("#fullBG"),k="undefined"===typeof a?
"undefined":_typeof(a),l=b.width||!1,b=(b.hasOwnProperty("showKill")?b.showKill:1)?popup.killLink({click:e}):"",e=$("body");l||(l="object"===k?a.measure(function(){return this.outerWidth()}):"600px");0===c.length&&e.a(c=h.div({id:"overlay"}));!g.length&&e.a(g=h.div({id:"fullBG"}).a(h.img({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAABmJLR0QAggCCAILTYnVvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQI12N8/fHeFgYGBgYmBigAADW7A3L6PuNkAAAAAElFTkSuQmCC",width:"100%",height:"100%"})));
g.fullscreenBackground({fillOnResize:!0});0!==$(".modal").length&&$(".modal:last").hide();g=h.div({c:"modal unselectable"}).css({position:"relative",width:l}).a(b?b.css({position:"absolute",right:0}):"","object"===k?h.p({style:"padding: 0; margin: 0;"}).a(a):h.p({style:"padding: 0; margin: 0;",html:a}));c.a(g).css({visibility:"visible"});f&&g.data("afterClose",f);return g},info:function(a,b){b=b||{};var c=b.width||"400px",e=b.afterClose||!1,f=b.killAll||!1;popup.show(h.div().a(fh.wrap().a(h.div({html:a,
style:"font-size: medium;"})),popup.buttons([{value:"Закрыть",hotKey:{key:keys.esc},click:function(){popup.kill({all:f});e&&e()}}])),{width:c,showKill:!1,paddingTop:"5px"});$('.popup-buttons div input[type="button"]').focus()},error:function(a,b){popup.info(h.span().a(h.button({c:"img img-cir-red vbottom"}),h.symbols.space,a||""),b||{})},header:function(a,b){b=b||{};a=a||"";var c=b.id||"",e=b.c||"",f=b.padding||"5px",g=b.hasOwnProperty("isText")?b.isText:!1,f=h.div({style:"padding: {0} 0 0 0;".f(f),
c:"popup-header fill-dark-green hleft"}),e={c:e};g&&(a=h.span({html:a,style:"padding-left: 8px;font-size: medium;"}));c&&(e.id=c);c=h.div(e);f.a(a,h.div({style:"width: 100%;border-bottom: 1px solid black;padding-top:5px;"}));return c.a(f)},buttons:function(a,b){b=b||{};a=a||[];var c=b.oVal("padding","5px"),e=h.div({c:"popup-buttons"}),f=h.div({style:"padding: {0} 0 {0} 0; text-align: center;".f(c),c:"fill-dark-green"});if(0===a.length)return e;e.a(h.div({style:"width: 100%;border-bottom: 1px solid black;"}));
$(a).each(function(a,b){b.c=b.c||"medium-button";b.html=b.value;f.a(field.button(utils.genId("button_"),b).prop("style",a?"margin-left: 10px;":""))});return e.a(f)},kill:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.all||!1,c=a.oVal("removeContent",!0),a=$("body");b?($(".modal").each(function(a,b){b.afterClose&&b.afterClose();$(b).remove()}),$("#overlay").css("visibility","hidden"),$("#fullBG").remove()):(b=$(".modal:last"),b.data("afterClose")&&b.data("afterClose")(),
c||(c=b.children(),a.a(c.hide())),b.remove(),0!==$(".modal").length?$(".modal:last").show():($("#overlay").css("visibility","hidden"),$("#fullBG").remove()))},killAll:function(){popup.kill({all:!0})},linkedShow:function(a,b,c){var e=utils.oVal("style","",c),f=utils.oVal("popupStyle","padding: 10px 10px 0 10px",c),g=utils.oVal("showKill",!0,c),k=utils.oVal("cloneClass","inline",c),e=h.div({style:e,c:k}).html(b[0].outerHTML);c=c.oVal("position","center");var k=b.attr("id"),l=b.zIndex();k&&e.children().eq(0).attr("id",
k+"-cloned");var n=h.div({style:"position:absolute;background-color:#fff;border: 1px solid black;opacity: 0",c:"linked-popup"}).a(g?h.div({c:"fright"}).a(popup.killLink({click:function(){n.remove()}})):"",h.div({c:"h"+c,style:f}).a(e),h.div({c:"cboth"}).a(a)).zIndex(l+1);e.click(function(){ui.fadeOut(n,{duration:$.fx.speeds._default,after:function(){n.remove()}})});$("body").a(n);a=b.offset();b=n.offset();f=e.offset();n.offset({left:a.left-(f.left-b.left),top:a.top-(f.top-b.top)});ui.fadeIn(n,{duration:$.fx.speeds._default});
return n},killLinked:function(){$(".linked-popup:last").remove()}},formHelper={fieldMediumWidth:221,fieldNoteWidth:422,fieldPadding:4,buttons:{saveCancel:function(){return[{value:"Сохранить",type:"submit",hotKey:{key:keys.enter,ctrl:!0}},{value:"Отмена",click:popup.kill,hotKey:{key:keys.esc}}]},addCancel:function(){return[{value:"Добавить",type:"submit",hotKey:{key:keys.enter,ctrl:!0}},{value:"Отмена",click:popup.kill,hotKey:{key:keys.esc}}]},close:function(){return{value:"Закрыть",click:popup.kill,
hotKey:{key:keys.esc}}},save:function(){return{value:"Сохранить",type:"submit",hotKey:{key:keys.enter,ctrl:!0}}},cancel:function(a){return{value:"Отмена",click:a,hotKey:{key:keys.esc}}},"delete":function(a){return{value:"Удалить",click:a,hotKey:{key:keys.del,ctrl:!0}}}},wrap:function(a){return h.div(a).css({padding:"16px"})},submitStart:function(a){a=$(a).find('[type="submit"]');a.length&&(ui.ajaxLoader(a,{position:"left"}),ui.disable(a))},submitStop:function(a){a=$(a).find('[type="submit"]');a.length&&
ui.enable(a)},ajaxProperty:function(a){return{beforeSend:function(){formHelper.submitStart(a)},complete:function(){formHelper.submitStop(a)}}},ajax:function(a){if(a.hasOwnProperty("form")){var b=a.form;delete a.form;return $.ajax($.extend(a,formHelper.ajaxProperty(b)))}console.error("Не заполнено свойство form")}},fh=formHelper,tableHelper={buttonWidth:32};var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},Table=function(a){a=a||{};var b=this;"conteinerId"in a||"conteiner"in a?(this.init=function(){b.id=a.oVal("id","table_"+Math.random());b.selector="#"+b.id;b.conteinerId=a.conteinerId;b.conteinerSelector="#"+b.conteinerId;b.conteinerCached=a.oVal("conteiner",$(b.conteinerSelector));b.titles=
a.oVal("titles",[]);b.items=a.oVal("items",[]);b.rawData=a.oVal("rawData",{});b.sum=a.oVal("sum",{show:!1});b.dataLink=a.oVal("dataLink",!1);b.dbCount=a.oVal("dbCount",0);b.pageCount=a.oVal("pageCount",0);b.pageMax=a.oVal("pageMax",10)+1;b.curPage=a.oVal("curPage",1);b.pageOffset=a.oVal("pageOffset",1);b.pageNavKey=a.oVal("pageNavKey",!1);b.titlesAlwaysShow=a.oVal("titlesAlwaysShow",!1);b.showEditButtons=a.oVal("showEditButtons",!0);b.onDraggable=a.oVal("onDraggable",!1);b.filtersExist=!1;b.paginationLoader=
a.oVal("paginationLoader",!1);b.autoLastPage=a.oVal("autoLastPage",!1);b.filters=a.oVal("filters",{});b.prepareData=a.oVal("prepareData",!1);b.cache=a.oVal("cache",{});b.afterShow=a.oVal("afterShow",!1);b.linkedTables=a.oVal("linkedTables",!1);b.isLoaderShow=a.oVal("isLoaderShow",!0);b.groupBy=a.oVal("groupBy","");$.isEmptyObject(b.filters)||(b.titlesAlwaysShow=b.filtersExist=!0);"function"!==typeof b.titles&&b.titles.length&&b.titles.map(function(a){a.hasOwnProperty("filter")&&(b.titlesAlwaysShow=
b.filtersExist=!0)})}(),this.conteiner=function(){!b.conteinerCached.length&&(b.conteinerCached=$(b.conteinerSelector));return b.conteinerCached},this.deleteButton=function(a){a=a||function(){};return h.button({c:"img img-delete",type:"button"}).click(a)},this.renderRow=function(c){if(!c.hasOwnProperty("show")||c.show){var e=h.tr().addClass("entityRow").data("id",c.id),f=c.date?ui.prettyDateTd(c.date):h.td().addClass("date");if(c.amount)var g=ui.itemAmount(c).amount,k=ui.itemAmount(c).amountWithoutComment;
if(c.fromName)var l=c.fromName.truncate({oneWord:!0,maxWidth:85});if(c.toName)var n=c.toName.truncate({oneWord:!0,maxWidth:85});if(c.accountName)var p=c.accountName.truncate({oneWord:!0,maxWidth:99});if(a.renderTr||a.renderRow)a.renderTr&&a.renderTr(e,c,b),a.renderRow&&a.renderRow(e,c,b);else switch(c.type){case "note":k=c.comment.nl2br();g=k==k.truncate()?"":k;k=html.span({html:k.truncate()});e.a(f,h.td({colspan:3,html:h.small().a("Заметка: "),title:g}).a(k));break;case "entry":e.a(f,h.td().html(c.categoryName.truncate({oneWord:!0,
maxWidth:category.maxWidth})),g,h.td().html(p.truncate({oneWord:!0,maxWidth:82})));break;case "categoryDetail":e.a(f,k,h.td().html(c.comment.nl2br().truncate()),h.td().html(p));break;case "movementDetail":e.a(f,h.td().a(h.table({c:"clear",width:"200"}).a(h.tbody().a(h.tr().a(h.td({html:l,style:"width:85px"}),h.td({html:'<span style="line-height: 0.7;font-size:17px;padding:0;">&rarr;</span>',style:"vertical-align:top;text-align:center;"}),h.td({html:n,style:"width:85px"}))))),g,h.td().html(" "));break;
case "debt":m=ui.itemAmount({positive:c.positive,amount:c.amount-c.dhamount,currencySymbol:c.currencySymbol});e.a(h.td({c:"one-word "+(0===c.comment.length?"":"comment"),title:0===c.comment.length?"":c.comment.nl2br(),html:c.personName.truncate({maxLongWordLen:10,oneWord:!0})}),m.amount,html.td({"class":"account"}).html(p),f,ui.prettyDateTd(c.created));break;case "debtHistory":debt.renderDebtHistoryRow(e,c);break;case "account":var m=html.span(),q=html.span();$(c.rems).each(function(a,b){"0"!==b.amount&&
(m.a(h.nobr().a(ui.prettyMoney({type:"onlyAmount",amount:b.amount})),h.br()),q.append(html.nobr({html:b.currencySymbol}),html.br()))});e.append(h.td({c:"1"===c.def?"bold":"",html:c.accountName.truncate({maxWidth:181,oneWord:!0})}),h.td({c:"right",style:"padding-right: 4px;"}).a(m),h.td({c:"last-cur"}).a(q)).attr("data-id",c.id);break;case "account_start_value":e.append(h.td({c:"right",style:"padding-right: 4px;"}).a(ui.prettyMoney({type:"onlyAmount",amount:c.amount})),h.td({c:"last-cur"}).append(c.currencySymbol))}e.hover(function(){e.hasClass("highlight")||
e.addClass("sel");if(b.showEditButtons){e.position();e.width();var f=e.outerHeight(),g=e.data("id"),k=b.table.find(".table-delete-button[data-id={0}]".f(g)),k=k.length?k:!1,l;k?k.show():(l=h.div({c:"table-delete-button hcenter ui sel",title:"Удалить"}).css({height:f,position:"absolute",verticalAlign:"middle",display:"flex",alignItems:"center"}).a(b.deleteButton().css({margin:"8px"})).attr("data-id",g).click(function(e){ui.ajaxLoader($(this),{position:"right"});a.remove&&a.remove(c,b);e.stopPropagation()}).mouseleave(function(){e.removeClass("sel");
l.hide()}),e.a(l))}},function(a){if(b.showEditButtons){var c=e.data("id"),c=b.table.find(".table-delete-button[data-id={0}]".f(c)),c=c.length?c:!1;a=a.toElement||a.relatedTarget;c&&a!==c[0]&&(c.hide(),$(this).removeClass("sel"))}else $(this).removeClass("sel")});e.click(function(){if(a.edit)a.edit(c,b,e);else{if("entry"===c.type||"note"===c.type||"categoryDetail"===c.type||"movementDetail"===c.type)"entry"!==c.type&&"categoryDetail"!==c.type&&"movementDetail"!==c.type||"1"!==c.arhive||popup.error("Нельзя редактировать записи, категория, счёт или валюта которых находится в архиве");
"debt"===c.type&&debt.windowShow(c,b);$(".lightGray").each(function(){$(this).removeClass("lightGray").addClass("black")})}});return e}},this.render=function(c,e){0<$(b.selector).length&&($(b.selector).siblings(".table-delete-button").remove(),$(b.selector).remove(),$(b.selector+"-basement").remove());var f=ui.makeTable({id:b.id,c:"simple entitys",titles:b.titles,tableStyle:a.style,table:b}),g=!1,k=0,l=e||b.items;!l.length&&b.prepareData&&b.rawData&&(l=b.prepareData(b),b.items=l);if(l&&0!==l.length||
!b.dataLink||b.filtersExist){if($(l).each(function(a,b){if(!b.hasOwnProperty("show")||b.show)g=!0,k++}),g||b.titlesAlwaysShow){if(0!==l.length&&g||!b.titlesAlwaysShow)ui.renderTableBody(f,l,b.renderRow),a.renderFooter&&a.renderFooter(b);else{var n=0;ui.renderTableBody(f,"Нет записей",function(a){n=f.thead.find("tr:first th").length;return h.tr().a(h.td({c:"hcenter",colspan:n}).html(a))});"function"===typeof b.titles&&b.titles(b,f.thead,{isEmpty:!0,colspan:n})}$(c).empty().a(f);if(b.sum.show&&1<k){var p=
h.tr();if("account"===b.sum.type){var l=record.amounts(l),m=h.span(),q=h.span();$.each(l,function(a,b){m.a(h.nobr().a(ui.prettyMoney({type:"onlyAmount",amount:b.sum})),h.br());q.a(h.nobr({html:b.currencySymbol}),h.br())});$.each(f.thead.find("tr:last > th"),function(a){var c=h.span().a("&nbsp;"),e="",f="";a+1===b.sum.colNumber?(c=m,e="hright bold",f="padding-right: 4px;"):a===b.sum.colNumber&&(c=q,e="last-cur bold");p.a(h.td({c:e,style:f}).a(c))})}else{var r=record.renderAmounts(l);$.each(f.thead.find("tr:last > th"),
function(a){a=a+1===b.sum.colNumber;p.a(html.td({style:a?"text-align:right;white-space:nowrap;font-weight:bold;":""}).a(a?r:"&nbsp;"))})}f.tfoot.first().a(p)}else if(!a.renderFooter){var l=h.tr(),t=0;f.thead.find("tr:first th").each(function(){var a=$(this).attr("colspan");t+=parseInt(a&&0!=a?a:1,10)});for(var u=0;u<t;u++)l.a(h.td());f.tfoot.first().a(l)}l=h.div({id:b.id+"-basement",css:{height:"28px",width:"100%",margin:"auto"}});b.dbCount>b.pageCount&&(b.autoLastPage&&(b.pageOffset=Math.floor(b.dbCount/
b.pageCount/b.pageMax)+1),b.autoLastPage=!1,h.div({c:"fleft"}).a(b.pagination(b.pageOffset,{count:b.dbCount,pageCount:b.pageCount,curPage:b.curPage,buttonsMaxCount:b.pageMax,loader:b.paginationLoader||!1})).ato(l));(u=b.pageCount&&0<b.items.length&&10<b.dbCount)&&b.items.length&&l.a(h.div({c:"fright",title:"Количество записей на странице"}).a(b.countSelect()));a.beforePageCount&&l.a(a.beforePageCount().css({paddingRight:u?"8px":0}));a.minWidth&&f.css({minWidth:a.minWidth+"px"});l.html()&&(u=a.minWidth||
f.measure(function(){return this.width()}),$(f).after(l.css({width:u+"px"})));b.onDraggable&&b.onDraggable(b);b.afterShow&&b.afterShow(b);b.table=f;f.data("entitiesTable",b)}}else ui.ajaxLoader(b.conteiner(),{position:"in-center"}),$.when(b.load()).then(function(){b.items&&0!==b.items.length&&b.render(b.conteiner())})},this.pagination=function(a,e){a=a||1;var f=e.count||0;if(0!==f){for(var g,k=e.curPage||1,l=e.buttonsMaxCount||10,n=0,p=e.loader||!1,m=[],q={value:h.symbols.leftArrow,notSelected:!0,
cssClass:"left-page-button",hotKey:b.pageNavKey?{key:keys.left,ctrl:!0}:{},click:function(){var a="";g.find("button").each(function(b){var c=$(this);c.hasClass("sel")&&1<b&&(b=$("#"+a),b.click(),b.hasClass("prev-pages-button")&&g.buttons().not(".next-pages-button").not(".right-page-button").last().click());a=c.attr("id")})}},r={value:h.symbols.rightArrow,notSelected:!0,cssClass:"right-page-button",hotKey:b.pageNavKey?{key:keys.right,ctrl:!0}:{},click:function(){var a=!1,b=g.buttons(),c=b.length;b.each(function(b){var e=
$(this);a?(e.click(),e.hasClass("next-pages-button")&&g.buttons().not(".prev-pages-button").not(".left-page-button").first().click(),a=!1):e.hasClass("sel")&&b<c-2&&(a=!0)})}},t={value:h.symbols.hellip,notSelected:!0,cssClass:"next-pages-button",click:function(){var f=a+l-2,k=b.pagination(f,e);b.pageOffset=f;g.replaceWith(k);g=k}},u={value:h.symbols.hellip,notSelected:!0,cssClass:"prev-pages-button",click:function(){var f=1<=a-l-1?a-l-1:1,k=b.pagination(f,e);b.pageOffset=f;g.replaceWith(k);g=k}},
f=Math.ceil(f/(e.pageCount||10)),w=b.id+"-pagination",v=a;n<l&&v<f;n++)v=a+n,m.push({cssClass:"pagination-button "+(v===k?"sel":""),value:v,click:function(){var a=this.value;p?p():ui.ajaxLoader(g,{offsetLeft:7});g.map(ui.disable);$.when(b.load({isResultWithCount:!0,isLoaderShow:!1,postData:{page:a,pageCount:b.pageCount}})).then(function(){b.curPage=parseInt(a);b.show()})}});a+n<f+1&&(m.pop(),m.push(t));1<a&&(m.shift(),m.unshift(u));m.unshift(q);m.push(r);return g=ui.buttons(m,{id:w})}},this.countSelect=
function(){var a=h.select({c:"count-item-on-page"});$([10,20,50,100]).each(function(e,f){var g=h.option({html:f,value:f});f===b.pageCount&&g.attr("selected",!0);a.a(g)});a.change(function(){b.pageCount=parseInt($(this).val());b.pageOffset=0;b.curPage=0;$.when(b.load({isResultWithCount:!0,postData:{beginNumber:b.curPage,pageCount:b.pageCount}})).then(function(){b.show()})});return a},this.paginationReset=function(){b.pageOffset=0;b.curPage=0},this.filter=function(a){if("function"===typeof a)$(b.items).each(function(b,
e){e.show=!1;a(e)&&(e.show=!0)});else{var e=a.field,f=a.value;$(b.items).each(function(a,b){b.show=!1;b[e]&&b[e]===f&&(b.show=!0)})}b.show()},this.load=function(a){if(b.dataLink){a=a||{};var e=a.oVal("postData",{}),f=a.oVal("isLoaderShow",!0);a=a.oVal("beforeLoad",!1);0===b.pageCount||"object"!==("undefined"===typeof e?"undefined":_typeof(e))||e.hasOwnProperty("pageCount")||(e.pageCount=b.pageCount,e.page=b.curPage,b.autoLastPage&&(e.autoLastPage=!0));"function"!==typeof b.titles&&$(b.titles).each(function(){this.hasOwnProperty("filterVal")&&
Object.keys(this.filterVal).length&&$.each(this.filterVal,function(){e[this.name]=this.value});if(this.hasOwnProperty("sort")){var a=this.sort;e[a.name]={direction:a.direction,index:a.index}}});b.filters&&$.each(b.filters,function(a,b){e[a]=b});f&&b.hasOwnProperty("thead")&&ui.ajaxLoader(b.thead,{position:"left",ajaxId:b.id+"-ajax"});e=a?a(e):e;return $.ajax({type:"POST",dataType:"json",url:b.dataLink,data:e,ajaxId:b.id+"-ajax",success:function(a){a=0===a.length?[]:a;a.hasOwnProperty("count")?(b.dbCount=
parseInt(a.count),b.items=a.items,b.autoLastPage&&(b.curPage=Math.floor(b.dbCount/b.pageCount)+1)):(b.prepareData&&(b.rawData=a,"function"===typeof b.titles&&(b.titles(b,b.thead.html("")),b.cache.skipMakeTitles=!0,b.cache.thead=b.thead.clone(!0,!0))),b.items=b.prepareData?b.prepareData(b):a)}})}console.error("Невозможно загрузить данные таблицы, отсутствует ссылка")},this.reload=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};b.cache={};b.linkedTables&&b.linkedTables.forEach(function(e){a.fromId&&
e.id===a.fromId||e.reload({fromId:b.id})});ui.disableNotInput($(b.selector));$.when(b.load({isLoaderShow:a.oVal("isLoaderShow",b.isLoaderShow)})).then(function(){a.filter?b.filter(a.filter):b.show();a.after&&a.after()})},this.show=function(){b.render(b.conteiner())}):console.error("Не задан контейнер таблицы")};var account={maxWidth:99,accounts:function(){return user.account},form:function(a){var b=h.div({id:"def-box",c:"vtop cell"}).a(h.label({"for":"def",html:"0"===a.def?"Основной":""}),h.br(),"1"===a.def?"<b>основной</b>":checkBoxField({id:"def",change:function(a){var b=$("#arhive");a.checked?(b.prop("checked",!1),b.attr("disabled","disabled"),ui.fadeOut($("#arhive-box"))):(ui.fadeIn($("#arhive-box")),b.removeAttr("disabled"))}})),c=h.div({c:"vtop cell",id:"arhive-box"}).a(h.label({"for":"arhive",html:"Архив"}),
h.br(),checkBoxField({id:"arhive",checked:"1"===a.arhive,change:function(a){var b=$("#def");a.checked?(b.prop("checked",!1),b.attr("disabled","disabled"),ui.fadeOut($("#def-box"))):(ui.fadeIn($("#def-box")),b.removeAttr("disabled"))}})),e=h.div().a(h.span({c:"unselectable lGray",html:"Остатки"}),h.br()),f=h.table(),g=h.span(),k=h.span();$(a.rems).each(function(a,b){g.a(h.nobr().a(ui.prettyMoney({type:"onlyAmount",amount:b.amount})),h.br());k.a(h.nobr({html:b.currencySymbol}),h.br())});e.a(f.a(h.tr().a(h.td({c:"hright"}).a(g),
h.td().a(k))));return h.form({id:"accountForm",submit:account.update}).a(h.input({type:"hidden",name:"id--id",value:a.id}),h.input({type:"hidden",name:"def--bool",value:"1"===a.def}),h.input({type:"hidden",name:"alias",value:a.alias}),fh.wrap({c:"dcenter"}).a(h.div({c:"row"}).a(h.div({c:"cell vbottom"}).a(field.text("accountName",{value:a.accountName,placeholder:"Название"}),"1"===a.def?"<br><b>основной</b>":""),h.div({c:"cell hcenter"}).a("0"===a.def&&"1"!==a.arhive?b.css({paddingLeft:"10px"}):"",
"1"!==a.def&&a.hasOwnProperty("id")?c.css({paddingLeft:"10px"}):"")),h.div({c:"vmiddle cboth"}).a(a.hasOwnProperty("id")?e.css({paddingTop:"14px"}):"")),popup.buttons([formHelper.buttons.save(),formHelper.buttons.cancel(function(){popup.kill();account.unselectNewAccOption()})]))},formShow:function(a){a=a||{};var b=new accountSv(a.id),c=popup.header(ui.buttons([{value:"Счёт",tabId:"account-tab",selected:!0},{value:"Начальные значения",tabId:"account-start-values-tab",click:function(){b.accountSvTable.show()}},
{value:"История",tabId:"account-details-tab",click:function(){account.detailsLoad(a.id)}}],{id:"tabs",style:"padding-left: 5px;",c:"medium"})),e=h.span().a(h.div({id:"account-tab"}).a(account.form(a)),h.div({id:"account-start-values-tab",c:"hide"}).a(b.tab()),h.div({id:"account-details-tab",c:"hide"}).a(h.div().css({padding:"10px"}).a(h.div({id:"account-details"})),popup.buttons([formHelper.buttons.close()])));popup.show(h.span().a(a.hasOwnProperty("id")?c:"",e),{onClose:function(){account.unselectNewAccOption();
popup.kill()}}).css({minWidth:"287px"});$("#accountName").focus()},def:function(){return{id:user.def.accountId}},unselectNewAccOption:function(){$(".account-select").each(function(){var a=$(this),b=a.val(),c=account.def().id;a.val(-1!==b.toString().indexOf("new")?c:b).change()})},detailsLoad:function(a,b){var c={id:a},e=$("#account-details");if(!e.html()){var f=new Date,g=new Date;g.setDate(f.getDate()-30);var k=field.period("account-detail-period",{from:dateHelper.dateToDefault(g),to:dateHelper.dateToDefault(f),
clearButton:!1}).css({display:"inline"}),f=ui.image("filter").addClass("inline vmiddle").css({marginLeft:"8px"}),l=new Table({id:"accountDetails",conteinerId:"account-details",dataLink:"/?action=account.details.json",filters:c,renderRow:function(a,b){a.a(h.td({html:ui.prettyDate(b.date),c:"date"}),h.td({html:b.reason,c:"category"}),h.td({c:"amount"}).a(ui.prettyMoney({amount:b.amount,symbol:b.symbol})),h.td({html:b.comment,c:"text"}))},sum:{show:!0,colNumber:3},pageCount:10,minWidth:700,showEditButtons:!1,
titles:[{c:"date"},{c:"category"},{c:"amount"},{c:"text"}]});h.div({css:{marginTop:"10px"}}).a(k,f).insertBefore(e);l.reload({after:function(){e.parents(".modal").width(l.conteiner().find("table").width()+40)}});f.click(function(){c.from=k.from().mysqlDate();c.to=k.to().mysqlDate();l.filters=c;l.reload()});return!1}},update:function(){var a=$("#accountForm"),b=a.find('button[type="submit"]');ui.ajaxLoader(b,{position:"left"});formHelper.ajax({type:"POST",dataType:"json",url:"/?action=account.update",
form:a,data:a.serialize()}).done(function(a){if(a.error)a.hasOwnProperty("text")?popup.info(a.text):showValidation(a.validation,{type:"tooltip",position:"left"});else{if("undefined"!==typeof accountsTable){accountsTable.items=a.entities;var b=$("#accounts-filter .sel");accountsTable.filter({field:"arhive",value:b.length?b.data("arhive"):"0"})}account.selectRefresh(a.entities,a.newId);popup.kill()}});return!1},selectRefresh:function(a,b){user.account=a;$(".account-select").each(function(){var a=$(this),
e=a.val(),f=0<a.find("option").filter(function(){return"newAcc"===$(this).val()}).length;"newAcc"===e&&0!==parseInt(b)&&(e=b);a.html(account.selectOptions({showAdd:f,defaultId:e}))})},"delete":function(a){"1"===a.def?(popup.info("Нельзя удалить основной счёт"),ui.ajaxLoadersHide()):$.ajax({type:"POST",dataType:"json",url:"/?action=account.delete",data:{id:a.id},success:function(a){if(a.error)popup.error(a.text);else{var c=$("#accounts-filter .sel");accountsTable.items=a.entities;accountsTable.filter({field:"arhive",
value:c.length?c.data("arhive"):"0"});account.selectRefresh(a.entities);popup.kill()}}})},selectOptions:function(a){var b=a.oVal("defaultId",!1),c=a.oVal("ignoreDef",!1),e=a.oVal("noneChoice",!1);a=a.oVal("showAdd",!0);var f=!1,g=[];e&&g.push(html.option({value:0,html:"&mdash;",selected:!0}));$.each(user.account,function(a,e){if("1"!==e.arhive||b&&e.id===b)f=c&&!b?!1:b?e.id===b:"1"===e.def,g.push(html.option({value:e.id,html:e.accountName.truncate({oneWord:!0,maxWidth:190}),selected:f}))});a&&g.push(h.option({value:"newAcc",
c:"green",html:"+ добавить счёт"}));return g},select:function(a,b){b.defaultId=b.oVal("defaultId",account.def().id);b.width=b.oVal("width",190);var c=b.oVal("tabIndex",!1);return field.select(a,$.extend({cssClass:"dcenter",selClass:"account-select",selOptions:account.selectOptions(b),tabIndex:c,addNew:function(){account.formShow()},valueField:"accountName"},b))},draggable:function(a){$(a.selector).find(".entityRow").each(function(){var b=$(this),c;b.draggable({containment:"#accountsTable",handle:"td:first",
appendTo:$(a.selector).parent(),helper:function(){$(a.selector+" tbody .entityRow").trigger("mouseleave");var b=$(this).children().eq(0);return h.table({c:"simple entitys"}).a(h.tr({c:"entityRow drag-helper"}).a(h.td({c:"vmiddle",html:b.html()}).width(b.width()).height(b.height()).css({border:"1px solid black"}).addClass(b.attr("class"))).data("id",b.parent().data("id")))},start:function(e,f){c=f.helper;$(a.selector).find(".entityRow").not(".drag-helper").each(function(){var a=$(this);a.data("ui-droppable")&&
a.droppable("destroy");a[0]!==b[0]&&a.droppable({hoverClass:"highlight-green",drop:function(a,b){var e=b.helper.find(".entityRow").data("id"),f=$(this).data("id");move.formShow({fromId:e,toId:f});$(c).remove()}})})}})})},defId:function(){return user.def.accountId}};var accountSv=function(a){var b=this;this.accountSvTable=new Table({id:"accountSvTable",conteinerId:"account-sv",dataLink:"/?action=accountsv.json&accountId="+a,remove:function(a){b["delete"](a)},edit:function(a){b.formShow(a)},titles:[{c:"amount"},{}]});this.formShow=function(a){popup.show(b.form(a),{width:"340px"});$("#amount").focus()};this.tab=function(){return h.span().a(h.div({c:"hleft",style:"padding: 6px 0 0 5px;"}).a(addButton({title:"Добавить начальное значение",click:function(){var c=[],
e=[],f=!0;$(user.currency).each(function(){"0"===this.arhive&&c.push(this)});$(b.accountSvTable.items).each(function(){e.push(this.currencyId)});$(c).each(function(){-1===$.inArray(this.id,e)&&(f=!1)});0<$("#"+b.accountSvTable.id).length&&f?popup.error("Начальные значения заданы для всех имеющихся валют"):b.formShow({accountId:a})}})),fh.wrap().css({paddingTop:0}).a(h.div({id:"account-sv"})),popup.buttons([fh.buttons.close()]))};this.form=function(a){var e=[];$(b.accountSvTable.items).each(function(b,
g){g.id!==a.id&&e.push(g.currencyId)});return h.form({id:"accountsv-form",submit:b.update}).a(h.input({type:"hidden",name:"id--id",value:a.oVal("id","")}),h.input({type:"hidden",name:"accountId--id",value:a.accountId}),fh.wrap().a(h.div({c:"table simple dcenter",style:"padding: 0 20px;"}).a(h.div({c:"row"}).a(h.div({c:"cell hleft",style:"max-width: 224px;"}).a(field.amount("amount",{type:"float",placeholder:"Сумма",value:a.amount,showCurrency:!0,excludeCurrencies:e,currencyId:a.oVal("currencyId",
user.def.currencyId)}))))),popup.buttons(fh.buttons.saveCancel()))};this.update=function(){$.ajax({type:"POST",dataType:"json",url:"/?action=accountsv.update",data:$("#accountsv-form").serialize()}).done(function(a){a.error?a.hasOwnProperty("text")?popup.error(a.text):showValidation(a.validation,{type:"tooltip",position:"left"}):(b.accountSvTable.items=a.entities,b.accountSvTable.show(),popup.kill(),b.refreshAccounts())});return!1};this["delete"]=function(a){$.ajax({type:"POST",dataType:"json",url:"/?action=accountsv.delete",
data:{id:a.id,accountId:a.accountId,amount:a.amount,currencyId:a.currencyId},success:function(a){a.error?popup.error(a.text):(b.accountSvTable.items=a.entities,b.accountSvTable.show(),b.refreshAccounts())}})};this.refreshAccounts=function(){accountsTable.reload({after:function(){$(accountsTable.items).each(function(b,c){c.id===a&&$("#account-tab").html(account.form(c))});var b=$("#accounts-filter .sel");accountsTable.filter({field:"arhive",value:b.length?b.data("arhive"):"0"})}})}};var debt={"delete":function(a,b){var c=a.id;if(0===c.length)console.error("Удаление долга без id");else{1===b.items.length&&1<b.curPage&&b.curPage--;var e=function(){$.ajax({type:"POST",dataType:"json",url:"/?action=debt.delete",data:{id:c,arhive:b.filters.arhive},success:function(a){!a.error&&b.reload()},complete:function(){popup.kill()}})};0<a.dhamount?(ui.ajaxLoadersHide(),popup.show(h.div().a(fh.wrap().a(h.span({c:"red"}).a("Внимание!",h.symbols.space),"Удаляя долг, вы удаляете всю историю, связанную с ним.",
h.br(),h.br(),"(Долг автоматически уйдёт в архив когда будет полностью погашен)"),popup.buttons([{value:"Удалить",click:e},formHelper.buttons.cancel(popup.kill)])))):e()}},histDelete:function(a,b,c){if(a.id||a.debt_id)return 1===b.items.length&&1<b.curPage&&b.curPage--,$.ajax({type:"POST",dataType:"json",url:"/?action=debtHist.delete",data:{id:a.id,debtId:a.debtId,positive:a.positive,amount:a.amount,currencyId:a.currencyId,type:a.type},success:function(a){a.error||b.reload({after:function(){debt.formRemainUpdate(c,
a.records)}})}})},form:function(a,b){a.accountId=a.id;var c=field.hidden("id",{type:"id",value:a.id}),e=field.hidden("positive",{type:"number",value:a.positive||"1"}),f,g=function(b){e.val(b);m.input().prop("placeholder",l());f.toggleClass("hidden",(a.positive||"1")!==e.val())};a.positive=a.positive||"1";var k=ui.buttons([{value:"вы взяли",selected:"1"===a.positive,click:function(){g(1)}},{value:"вы дали",selected:"0"===a.positive,click:function(){g(0)}}]);a.typeButtons=k;var l=function(){return"0"===
e.val()?"Должник":"Спонсор"},n={paddingBottom:"4px"},p,m,q={c:"optional-field hidden"},r=account.select("parentId",{width:formHelper.fieldMediumWidth,items:user.account,isCloud:!0,defaultId:a.parentId,cloudOptions:{width:formHelper.fieldMediumWidth,fontMin:12,fontMax:16,style:"padding-top: 4px;",percentFilter:.02,isShowOne:!1,click:function(a){$("#parentId").val(a.id)}}}),t=h.div().a(h.form({id:"debt-form",css:{textAlign:"left"},submit:function(){formHelper.ajax({form:t,type:"POST",dataType:"json",
url:"/?action=debt.update",data:$("#debt-form").serialize(),success:function(a){a.error?showValidation(a.validation,{type:"tooltip",position:"left"}):(b.reload(),popup.kill())}});return!1}}).a(c,e,fh.wrap().a(h.div({c:"hcenter"}).css({paddingBottom:"16px"}).a(k),h.div({c:"cboth"}).a(h.div().css(n).a(m=field.text("accountDebtName",{value:a.personName,width:formHelper.fieldMediumWidth,placeholder:l()})),h.div().css(n).a(h.nobr().a(field.amount("amount",{value:a.amount,placeholder:"Сумма",currencyId:a.currencyId||
currency.defId()}))),h.div({c:a.id?"":"hide"}).css({padding:"4px 0",height:"35px"}).a(h.div({c:"fleft"}).a(h.span().a("Остаток:",h.br()).doUnselectable(),h.span({id:"debt-remain",c:"bold"}).a(ui.prettyMoney({amount:a.amount-a.dhamount,currencySymbol:a.currencySymbol})).data("rem_value",a.amount-a.dhamount)),h.div({c:"fright"}).a(f=h.button({type:"button",css:{height:"24px"}}).click(function(){debt.histFormShow({debtHistItem:{debtId:a.id,amount:$("#debt-remain").data("rem_value"),accountId:a.id,currencyId:a.currencyId},
debtTable:b,debt:a});return!1}).a(ui.image("1"===e.val()?"up-right":"down-left").addClass("vmiddle"),html.symbols.space,"1"===e.val()?"Вернуть":"Отдали"))),h.div().css(n).css({paddingTop:"4px"}).a(r),h.div({c:"ui lGray hcenter"}).css({padding:"6px 0"}).a(h.symbols.downTriangle).click(function(a){var b=$(".optional-field");b.slideToggle(function(){$(a.target).html("none"===b.css("display")?h.symbols.downTriangle:h.symbols.upTriangle)})}),h.div(q).css(n).css({paddingTop:"4px"}).a(h.div({c:"dcenter lGray"}).css(p=
{width:"107px",textAlign:"right",marginRight:"5px"}).a(h.label({"for":"created"}).text("Добавлен")),h.div({c:"dcenter"}).a(field.date("created",{clearButton:!1,sqlValue:a.created}))),h.div(q).css(n).a(h.div({c:"dcenter lGray"}).css(p).a(h.label({"for":"returnDate"}).text("Вернуть до")),h.div({c:"dcenter"}).a(field.date("returnDate",a.date?{sqlValue:a.date}:{value:""}))),h.div(q).a(field.comment("comment",{width:formHelper.fieldMediumWidth,value:a.comment})))),popup.buttons(fh.buttons.saveCancel(),
{hrPadding:0}))),c=function(){k.map(function(b){var c=t.find("#currencyId");a.dhamount?(ui.disableSelect(c),ui.disable(b),b.prop("title","Нельзя менять тип долга с непустой историей"),c.prop("title","Нельзя менять валюту долга с непустой историей")):(ui.enable(c),ui.enable(b),b.prop("title",""),c.prop("title",""))})};a.buttonsToggle=c;c();return t},loaderShow:function(){var a=$("#tabs").find("button:last");a.length&&ui.ajaxLoader(a,{position:"right",offsetLeft:4})},windowShow:function(a,b){var c,
e,f=popup.header(ui.buttons([{value:"Долг",tabId:"debt-tab",selected:!0},{value:"История",tabId:"debt-hist-tab",click:function(){e()}}],{id:"tabs",style:"padding-left: 5px;",c:"medium"}),{id:"debt-header"}),f=h.div({id:"debt-edit-window"}).a(a.dhamount?f:"",h.div({id:"debt-tab"}).a(debt.form(a,b)),c=h.div({id:"debt-hist-tab",c:"hide"})),g=new Table({id:"debtHistTable",conteinerId:"debt-hist-table",dataLink:"/?action=debtHist.json&id={0}".f(a.id),pageCount:10,pageMax:2,paginationLoader:debt.loaderShow,
autoLastPage:!0,pageNavKey:!0,style:'min-width: "400px"',titles:[{},{c:"mw100"}],edit:function(c,e){debt.histFormShow({debtHistItem:c,debtHistTable:e,debtTable:b,debt:a})},remove:function(c,e){$.when(debt.histDelete(c,e,a)).then(function(){b.reload({filter:debt.filter()})})}});popup.show(f);e=function(){c.html()||(debt.loaderShow(),$.when(g.load()).then(function(){$("#debt-header");c.a(fh.wrap({css:{textAlign:"left"}}).a(addButton({title:"Добавить возврат",click:function(){debt.histFormShow({debtHistItem:{debtId:a.id,
amount:a.amount-a.dhamount,accountId:a.id,currencyId:a.currencyId},debtHistTable:g,debt:a,debtTable:b})}}),h.div({id:"debt-hist-table"})),popup.buttons([fh.buttons.close()],{hrPadding:0}));g.show()}))}},filter:function(){return{field:"arhive",value:$("#debts-filter").find(".sel").data("arhive")}},histFormShow:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.debtHistItem,c=a.debtHistTable,e=a.debt,f=a.debtTable,a={c:"hcenter",css:{marginBottom:"4px"}},g={css:{display:"inline-block",
width:"70px"}},k=h.div().a(h.form({id:"debt-hist-form",css:{textAlign:"left"},submit:function(){formHelper.ajax({form:k,type:"POST",dataType:"json",url:"/?action=debtHist.update",data:$("#debt-hist-form").serialize(),success:function(a){a.error?showValidation(a.validation,{type:"tooltip",position:"left"}):(debt.formRemainUpdate(e,a.records),c?(debt.loaderShow(),c.reload({isLoaderShow:!1,after:function(){f.reload({filter:debt.filter()});popup.kill()}})):f.reload({filter:debt.filter(),after:popup.killAll}))}});
return!1}}).a(field.hidden("id",{type:"id",value:b.id}),field.hidden("debtId",{type:"id",value:b.debtId}),field.hidden("positive",{type:"number",value:e.positive}),field.hidden("currencyId",{type:"id",value:e.currencyId}),fh.wrap().a(h.div().a(h.div(g).a("0"===e.positive?"Должник":"Спонсор").doUnselectable(),e.person_name),h.div({css:{paddingBottom:"16px"}}).a(h.div(g).a("Остаток").doUnselectable(),ui.prettyMoney({amount:e.amount-(e.dhamount||0),currencySymbol:e.currencySymbol})),h.div(a).a(field.date("debtHistoryDate",
{value:void 0===b.date?"now":dateHelper.mysqlToDefault(b.date),showNav:!0,navKey:!0,clearButton:!1})),h.div(a).a(a=field.amount("dhAmount",{width:fh.fieldMediumWidth,value:b.amount,showCurrency:!1})),h.div().a(field.comment("comment",{width:fh.fieldMediumWidth,value:b.comment}))),popup.buttons(fh.buttons.saveCancel())));popup.show(k);a.input().focus().select()},formRemainUpdate:function(a,b){var c=$("#debt-remain"),e;if(0!==c.length){if(0===b.length)e={sum:0};else{e=record.amounts(b);var f=b[0];e=
e["0"===f.positive?"1":"0"][f.currencyId]}a.dhamount=e.sum;e=a.amount-e.sum;c.html(ui.prettyMoney({amount:e,currencySymbol:a.currencySymbol})).data("rem_value",e);a.buttonsToggle()}},table:function(a,b){var c=[],e=[],f=h.table({c:"rem",cellpadding:0,cellspacing:0,css:{paddingBottom:"24px"}});$(b).each(function(){"0"===this.arhive&&("0"===this.positive?c:e).push(this)});$([c,e]).each(function(b,c){if(0!==c.length){f.a(h.tr({c:"header_center_bold"}).a(h.td({colspan:3,css:{borderBottom:"1px solid #ddd"}}).html(0===
b?"Должники":"Спонсоры")));$(c).each(function(){f.a(h.tr().a(h.td({css:{borderRight:"1px solid #ddd"}}).html(this.personName),h.td({c:"hright"}).a(h.nobr().a(ui.prettyMoney({type:"onlyAmount",amount:this.amount-this.dhamount}))),h.td({c:"tdcur"}).html(this.currencySymbol)))});if(1<c.length){var e=record.renderAmounts(c,{separately:!0}),n=html.span(),p=html.span();$(e.amounts).each(function(a,b){n.a(h.nobr().a(ui.prettyAmount(b)).a(html.br()));p.a(h.nobr().a(e.curSymbols[a]).a(html.br()))});var m=
{css:{borderTop:"1px solid #ddd"}};f.a(h.tr().a(h.td(m).html(h.symbols.space),h.td($.extend(m,{c:"hright"})).a(n),h.td($.extend(m,{c:"tdcur"})).a(p)))}f.a(h.tr().a(h.td({colspan:3}).html(h.symbols.space)));a.a(f)}})},renderDebtHistoryRow:function(a,b){var c=ui.itemAmount({positive:b.positive,amount:b.amount,comment:b.comment,currencySymbol:b.currencySymbol}).amount,e=b.date?ui.prettyDateTd(b.date):h.td({c:"date"});a.a(e,c)}};var currency={renderTr:function(a,b){a.append(h.td().a(b.curName),h.td().a(b.curSymbol)).addClass("{0}".f("1"===b.def?"bold":""))},formShow:function(a,b){a=a||{};var c=h.div({c:"cell vtop",id:"def-box"}).a(h.label({"for":"def",html:"0"===a.def?"Основная":""}),h.br(),"1"===a.def?"<b>основная</b>":checkBoxField({id:"def",change:function(a){var b=$("#arhive");a.checked?(b.prop("checked",!1),b.attr("disabled","disabled"),ui.fadeOut($("#arhive-box"))):(ui.fadeIn($("#arhive-box")),b.removeAttr("disabled"))}})),
e=h.div({c:"cell vtop",id:"arhive-box"}).a(h.label({"for":"arhive",html:"Архив"}),h.br(),checkBoxField({id:"arhive",checked:"1"===a.arhive,change:function(a){var b=$("#def");a.checked?(b.prop("checked",!1),b.attr("disabled","disabled"),ui.fadeOut($("#def-box"))):(ui.fadeIn($("#def-box")),b.removeAttr("disabled"))}})),c=h.div().a(h.form({id:"currency-form",submit:currency.update}).a(h.input({type:"hidden",name:"id--id",value:a.id}),h.input({type:"hidden",name:"def--bool",value:"1"===a.def}),h.input({type:"hidden",
name:"alias",value:a.alias}),fh.wrap().a(h.div({c:"table simple dcenter"}).a(h.div({c:"row"}).a(h.div({c:"cell hleft",style:"max-width:170px;"}).a(h.label({"for":"curName",html:"Название валюты"}),h.br(),field.text("curName",{value:a.curName}),"1"===a.def?"<br><b>основная</b>":""),h.div({c:"cell hleft vtop",style:"max-width:170px;"}).a(h.label({"for":"curSymbol",html:"Символ"}),h.br(),field.text("curSymbol",{width:60,value:a.cur_symbol})),"0"===a.def&&"1"!==a.arhive?c:"","1"!==a.def&&a.hasOwnProperty("id")?
e:""))),popup.buttons([formHelper.buttons.save(),formHelper.buttons.cancel(function(){popup.kill();currency.unselectNewCurOption()})])));popup.show(c,{onClose:function(){currency.unselectNewCurOption();popup.kill()}});c=$("#curName");c.focus();c[0].selectionStart=c.val().length},unselectNewCurOption:function(){$(".currency-select").each(function(){var a=$(this),b=a.val(),c=currency.def().id;a.val("newCur"===b?c:b)})},update:function(){var a=$("#currency-form");formHelper.ajax({type:"POST",dataType:"json",
url:"/?action=currency.update",form:a,data:a.serialize()}).done(function(a){a.error?a.hasOwnProperty("text")?popup.info(a.text):showValidation(a.validation,{position:"afterField"}):("undefined"!==typeof currenciesTable&&(currenciesTable.items=a.entities,currenciesTable.filter({field:"arhive",value:$("#currencies-filter .sel").data("arhive")})),user.currency=a.entities,$(".currency-select").each(function(){var c=$(this),e=c.val(),f=a.newId,g=0<c.find("option").filter(function(){return"newCur"===$(this).val()}).length;
"newCur"===e&&0!==parseInt(f)&&(e=f);c.replaceWith(currency.select({showAdd:g,defaultId:e}))}),popup.kill())});return!1},"delete":function(a){"1"===a.def?(popup.error("Нельзя удалить основную валюту"),ui.ajaxLoadersHide()):$.ajax({type:"POST",dataType:"json",url:"/?action=currency.delete",data:{id:a.id},success:function(a){a.error?popup.error(a.text):(user.currency=a.entities,currenciesTable.items=a.entities,currenciesTable.filter({field:"arhive",value:$("#currencies-filter .sel").data("arhive")}),
popup.kill())}})},select:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.id||"currencyId",c=a.defaultId||!1,e=utils.oVal("ignoreDef",!1,a),f=utils.oVal("showAdd",!1,a),g=utils.oVal("tabIndex",!1,a),k=h.select({id:b,name:b+"--id",c:"currency-select"}),l=!1,n=a.noneChoice||!1,p=a.excludeCurrencies||[],m=utils.oVal("change",function(){},a);g&&k.attr("tab-index",g);n&&$(k).a($("<option>",{value:0,html:"&mdash;",selected:!0}));$.each(user.currency,function(a,b){-1===$.inArray(b.id,
p)&&("1"!==b.arhive||c&&b.id===c)&&(l=e&&!c?!1:c?b.id===c:"1"===b.def,$(k).a($("<option>",{value:b.id,html:b.curSymbol,selected:l})))});f&&$(k).a(h.option({value:"newCur",c:"bold large green",html:"+",title:"Добавить новую валюту"}));k.change(function(){m();f&&"newCur"===$("#"+b).val()&&currency.formShow()});return k},def:function(){var a=user.def.currencyId;return{id:a,symbol:currency.symbol(a)}},symbol:function(a){return $(user.currency).filter(function(){return this.id==a})[0].curSymbol},activeList:function(){return $(user.currency).filter(function(){return"0"===
this.arhive})},defId:function(){return user.def.currencyId}};var category={maxWidth:211,categories:function(a){return(a=a||!1)?{inc:$(user.category.inc).filter(a),exp:$(user.category.exp).filter(a)}:user.category},filter:function(){return{field:"arhive",value:$("#category-filter .sel").data("arhive")}},splitEntities:function(a){var b=[],c=[];$.each(a,function(a,f){"0"===f.positive?b.push(f):c.push(f)});return{expenses:b,income:c}},"delete":function(a,b,c){0!==a.length&&$.ajax({type:"POST",dataType:"json",url:"/?action=category.delete",data:{id:a},success:function(a){a.error?
popup.error(a.msg):(entities=a.entities,category.selectRefresh(a.entities),b.items=entities.exp,c.items=entities.inc,b.filter(category.filter()),c.filter(category.filter()))}})},afterUpdate:function(a,b,c){a.error?showValidation(a.validation):(entities=category.splitEntities(a.entities),b.items=a.entities.exp,c.items=a.entities.inc,b.filter(category.filter()),c.filter(category.filter()),popup.kill(),category.selectRefresh(a.entities))},formShow:function(a,b,c){console.log(a);var e=h.div().a(h.form({id:"category-form",
style:"text-align: left;",submit:function(){fh.ajax({type:"POST",dataType:"json",url:"/?action=category.update",form:e,data:$("#category-form").serialize(),success:function(a){a.error?showValidation(a.validation,{type:"tooltip",position:"left"}):(category.selectRefresh(a.entities,a.newId),a=a.entities,"undefined"!==typeof b&&"undefined"!==typeof c&&(b.items=a.exp,c.items=a.inc,b.filter(category.filter()),c.filter(category.filter())),popup.kill())}});return!1}}).a(h.input({type:"hidden",name:"id--id",
value:a.id}),h.input({id:"positive",type:"hidden",name:"positive--number",value:a.positive}),h.input({id:"alias",type:"hidden",name:"alias--string",value:a.alias}),fh.wrap({c:"table"}).a(h.div({c:""}).a(h.div({c:"cell vbottom",style:"max-width:240px;"}).a(field.text("name",{value:a.value,placeholder:"Название"})),h.div({c:"cell vbottom hcenter",css:{paddingLeft:"16px",minWidth:"150px"}}).a(ui.buttons([{value:"расходная",selected:"0"===a.positive,click:function(){e.find("#positive").val(0)}},{value:"доходная",
selected:"1"===a.positive,click:function(){e.find("#positive").val(1)}}])),h.div({c:"cell vbottom hright hcenter"+(""===a.id?" hide":""),css:{paddingLeft:"16px"}}).a(h.label({"for":"arhive",html:"Архив"}),h.br(),h.input({c:"css-checkbox",id:"arhive",name:"arhive--string",type:"checkbox",checked:"1"===a.arhive}),h.label({"for":"arhive",c:"checkbox-label",html:""}))),h.div({c:"hcenter",css:{paddingTop:"16px"}}).a(h.a({c:"ui",html:"Предустановленные параметры",title:"Автоматически установятся при выборе категории"}).click(function(){$("#def-param").slideToggle()})),
h.div({c:"hcenter",id:"def-param",style:"display: none"}).a(h.div({c:"dcenter",css:{paddingTop:"16px"}}).a(h.div({c:"hleft",style:"float: left; padding-right: 16px;"}).a(h.label({"for":"account",html:"Счёт"}),h.br(),account.select("accountId",{noneChoice:!0,ignoreDef:!0,defaultId:a.accountId})),h.div({c:"inline fleft"}).a(h.label({"for":"currency",html:"Валюта"}),h.br(),currency.select({noneChoice:!0,ignoreDef:!0,defaultId:a.currencyId}))))),popup.buttons([formHelper.buttons.save(),formHelper.buttons.cancel(function(){category.unselectNewCatOption();
popup.kill()})])));popup.show(e);ui.focusAndEndCursor(e.find("#name"));return e},templatesShow:function(a,b,c){function e(a,b,c){c=c||!1;var e="chb_{0}_{1}".f(a.positive,b),f="text_{0}_{1}".f(a.positive,b);return h.span().a(h.input({type:"checkbox",id:e,name:e,checked:c,c:"vmiddle"}),h.input({type:"text",c:"category",id:f,name:f,value:a.name,style:"margin-left: 4px;"}).click(function(){$("#chb_{0}_{1}".f(a.positive,b)).prop("checked",!0)}))}a=a||!1;var f=[{name:"Благотворительность",positive:0},{name:"Бытовая техника",
positive:0},{name:"Бытовая химия",positive:0},{name:"Дети",positive:0},{name:"Домашние животные",positive:0},{name:"Еда и напитки",positive:0},{name:"Интернет",positive:0},{name:"Коммунальные платежи",positive:0},{name:"Машина",positive:0},{name:"Медицина",positive:0},{name:"Одежда и обувь",positive:0},{name:"Подарки",positive:0},{name:"Путешествия",positive:0},{name:"Разовые траты",positive:0},{name:"Сотовый",positive:0},{name:"Транспорт",positive:0},{name:"Хаос",positive:0},{name:"Зарплата",positive:1},
{name:"Подработки",positive:1}],g=h.div({style:"padding-top: 0;",c:"hcenter"}).a(popup.header(a?"Стандартные категории":"Выберите категории из списка",{isText:!0}),h.form({id:"category-template-form",style:"text-align: left;",submit:function(){var e=!1;$('[id^="chb"]').each(function(a,b){b.checked&&(e=!0)});if(!e)return popup.error("Вы не выбрали ни одной категории"),!1;formHelper.ajax({type:"POST",dataType:"json",url:"/?action=category.templates.add",form:g,data:$("#category-template-form").serialize(),
success:function(e){user.data.load(!0);a?location.href="/add":category.afterUpdate(e,b,c)}});return!1}}).a(fh.wrap().a(h.table({id:"category-templates-table",c:"clear"}).a(h.tr().a(h.th({html:"Расходные"}),h.th({html:"Доходные"}).css({paddingLeft:"24px;"})))),popup.buttons(formHelper.buttons.addCancel()))),k=0,l=f.filter(function(a){if(1===a.positive)return a}),n=l.length,p=$(g).find("#category-templates-table");$(f).each(function(b,c){var f=l[k];p.a(h.tr().a(h.td().append(0===c.positive?e(c,b,a):
h.span()),k++<n?h.td({style:"padding: 4px 0 0 24px;"}).append(e(f,b,a)):""))});popup.show(g)},selectOptions:function(a){var b="exp"!==a.oVal("catType","exp")?"inc":"exp",c=a.oVal("showAdd",!0),e=a.oVal("defaultId",!0);a=user.category[b];var f=[];f.push(h.option({value:"-1",text:"exp"===b?"Расходные категории":"Доходные категории"}));$.each(a,function(a,b){var c=e&&b.id===e;f.push(h.option({value:b.id,html:b.value.truncate({oneWord:!0,maxWidth:category.maxWidth}),selected:c}).data({item:b}))});c&&
f.push(h.option({value:"newCat",c:"green",html:"+ добавить категорию"}));return f},select:function(a,b){var c="exp"!==b.oVal("catType","exp")?"inc":"exp",e=user.category[c];b.width=b.oVal("width",240);e=field.select(a,$.extend({selClass:"category-select",selOptions:category.selectOptions(b),items:e,addNew:function(){category.formShow({positive:"exp"===c?"0":"1",id:""})}},b));e.find("select").data("catType",c);return e},unselectNewCatOption:function(){$(".category-select").each(function(){var a=$(this),
b=a.val();a.val(-1!==b.toString().indexOf("new")?-1:b).change()})},selectRefresh:function(a,b){user.category=a;$(".category-select").each(function(){var a=$(this),e=a.data("catType"),f=a.val(),g=0<a.find("option").filter(function(){return"newCat"===$(this).val()}).length;"newCat"===f&&0!==parseInt(b)&&(f=b);a.html(category.selectOptions({catType:e,showAdd:g,defaultId:f})).change()})},cntChange:function(a,b){var c="0"===a.positive?"exp":"inc",c=$(category.categories()[c]).filter(function(b,c){return c.id===
a.id})[0];if(!c)return!1;c.cnt=(parseInt(c.cnt)+b).toString();return c.cnt}};var move={renderRow:function(a,b){$(a).a(ui.prettyDateTd(b.date),h.td().a(b.fromName.truncate({maxWidth:99,oneWord:!0})),h.td({c:"vtop",style:"line-height: 0.7;font-size:large;width:20px;"}).html(h.symbols.rightArrow),h.td().a(b.toName.truncate({maxWidth:99,oneWord:!0})),ui.itemAmount(b).amount)},update:function(){var a=$("#moves-form");console.log("new form");formHelper.ajax({type:"POST",dataType:"json",url:"/?action=move.update",form:a,data:a.serialize()+"&"+$.param({page:$("#movesTable-pagination button.sel").html(),
pageCount:$("div#moves .count-item-on-page").val()})}).done(function(a){if(!a.error)return"undefined"!==typeof movesTable&&(movesTable.items=a.entities,$.when(movesTable.load({isResultWithCount:!0})).then(function(){movesTable.show()})),accountsTable.reload({after:function(){var a=$("#accounts-filter .sel");accountsTable.filter({field:"arhive",value:a.length?a.data("arhive"):"0"})}}),popup.kill(),!1;a.hasOwnProperty("text")?popup.error(a.text):showValidation(a.validation,{type:"tooltip",position:"left"})});
return!1},"delete":function(a){return $.ajax({type:"POST",dataType:"json",url:"/?action=move.delete",data:{id:a.id,amount:a.amount,currencyId:a.currencyId,fromId:a.fromId,toId:a.toId,page:$("#movesTable-pagination button.sel").html(),pageCount:$("div#moves .count-item-on-page").val()},success:function(a){a.error?popup.error(a.text):($.when(movesTable.load({isResultWithCount:!0})).then(function(){movesTable.show()}),popup.kill(),accountsTable.reload({after:function(){accountsTable.filter({field:"arhive",
value:$("#accounts-filter .sel").data("arhive")})}}))}})},formShow:function(a){if("1"===a.arhive)popup.error("Нельзя редактировать записи, счёт или валюта которых находится в архиве");else{var b,c,e=function(){move.selectsValidate(b.find("select"),c.find("select"))},f=field.date("mdate",{showNav:!0,navKey:!0,sqlValue:a.date}),g=field.amount("amount",{placeholder:"Сумма",value:a.amount,currencyId:a.currencyId||currency.def().id}),k=field.textarea("moveComment",{placeholder:"Комментарий",value:a.comment,
cols:30}),l=h.a({c:"hand hcenter",html:"Комментарий"}).click(function(){k.show();k.find(".textarea-input").focus();$(this).remove()});a.comment?l="":k.hide();b=account.select("fromAccount",{change:e,defaultId:a.fromId});c=account.select("toAccount",{change:e,defaultId:a.toId});a=h.div().a(h.form({id:"moves-form",submit:move.update}).a(h.input({type:"hidden",name:"id--id",value:a.id}),fh.wrap().a(f,h.div({c:"cboth hcenter p16"}).a(h.nobr().a(b,h.a({c:"large ui",style:"margin: 0 10px;",title:"Поменять местами"}).a(h.symbols.rightArrow).click(function(){move.selectsSwap(b.find("select"),
c.find("select"))}),c)),g,h.div().a(l,k).css({paddingTop:"16px"})),popup.buttons([fh.buttons.save(),fh.buttons.cancel(popup.kill)])));e();popup.show(a);ui.focusAndEndCursor(g.find(".amount-input"))}},selectsValidate:function(a,b){var c=a.prop("selectedIndex"),e=b.prop("selectedIndex");a.find(":selected").val()===b.find(":selected").val()&&(e=c===a.find("option").length-1?1:c+2,b.find(":nth-child({0})".f(e)).prop("selected",!0),e=b.prop("selectedIndex"));$.each(a.find("option"),function(a){$(this).prop("disabled",
a===e)});$.each(b.find("option"),function(a){$(this).prop("disabled",a===c)})},selectsSwap:function(a,b){var c=a.prop("selectedIndex"),e=b.prop("selectedIndex");field.selectSetEnable(a);field.selectSetEnable(b);b.find(":nth-child({0})".f(c+1)).prop("selected",!0);a.find(":nth-child({0})".f(e+1)).prop("selected",!0);move.selectsValidate(a,b)}};var user={cookieKey:"user",data:{fromJson:function(a){$.each(JSON.parse(a),function(a,c){user[a]=c});return!0},load:function(){$.ajax({url:"/?action=user.get-data"}).done(function(a){user.data.fromJson(a)})},fromCookies:function(){var a=Cookies.get(user.cookieKey);return void 0===a||"{}"===a.trim()?!1:user.data.fromJson(a,!1)}}};
function _logon(){var a=$("#l");if(!a.val()||!$("#p").val())return popup.info("Введите почту/ник и пароль",{afterClose:function(){a.focus()}}),!1;$.ajax({type:"POST",dataType:"json",url:"/?action=logon",data:$("#logon_form").serialize(),success:function(a){a.error?popup.info(a.text):(a=getUrlParameters("ret"),location.href=a?"/{0}".f(a):"/add")}});return!1}
function pass_recovery_show(){$.ajax({url:"/?action=pass.recovery.show"}).success(function(a){empty_cell();$("#main").html(a);$("#email").focus()})}function logout(){$.ajax({url:"/?action=logout",success:function(){window.location="/"}})}
function checkAndSendPass(){var a=d("email").value,b=d("captcha_key").value;checkEmail({emailField:$("#email"),isNotExistsError:!0,callback:function(c){c.error?hightlightTextTD("email_error",c.validation.text):(clearHightlightTdById("email_error"),clearHightlightTdById("captcha_error"),checkCaptcha()&&$.ajax({type:"POST",url:"/?action=pass.send",data:{email:a,captcha_key:b},success:function(a){"ok"==a?popup.info("Пароль отправлен на почту",{afterClose:function(){window.location="/"}}):"wrong_captcha"==
a?captchaError():console.log("Неизвестная ошибка при восстановлении пароля")}}))}});return!1}function checkCaptcha(){var a=d("captcha_key");return/^\s*$/.test(a.value)?(hightlightTextTD("captcha_error","Введите текст с картинки"),a.focus(),!1):!0}function captchaError(){var a=d("captcha_key");hightlightTextTD("captcha_error","Введённый текст не совпадает<br /> с символами на картинке");a.focus();a.select();d("captcha").src=d("captcha").src+"&"+Math.random()}
function generatePassword(){for(var a="",b=0;7>b;++b)a+="_-abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(63*Math.random()));return a};var note={table:function(a,b,c){c=c||{};return new Table({id:"noteTable",conteiner:b,dataLink:"/?action=records.json",linkedTables:c.linkedTables,pageCount:10,minWidth:540,filters:{note:!0,entry:!1,move:!1,noteDate:a[0].date,noteSort:{direction:0}},items:a,titles:[{c:"date"},{c:"text"}],renderTr:function(a,b){var c=h.td().a((b.note||b.comment).truncate({oneWord:!0,maxWidth:fh.fieldNoteWidth})),k=b.date?ui.prettyDateTd(b.date):h.td({c:"date"});a.a(k,c)},edit:note.edit,remove:record["delete"]})},edit:function(a,
b,c,e){e=e||{};var f=record.form({mode:"editOneRecord",disableButtons:!0,type:"note",inPopup:!0,recordsTable:b});popup.show(h.div().css({paddingTop:"14px"}).a(f.a(popup.buttons(fh.buttons.saveCancel()).css({paddingTop:"14px"}))),{afterClose:function(){var a=b&&b.linkedTables||e.linkedTables;a&&a.forEach(function(a){a.reload()})}});f.edit({id:a.id,type:"note",comment:a.note||a.comment,date:a.date},b,c)}};function personalTab(a,b){$("#email-field").replaceWith(field.email({value:a,excludeUser:!0}));$("#login-field").replaceWith(field.text("login",{value:b,width:200,blur:function(){g()},buttons:[{id:"check-login",img:"img-cir-green",title:"проверить",click:function(){g()}}]}));var c=$("#login");c.data("old",b);$("#cur-pass-field").replaceWith(field.text("cur-pass",{input_type:"password",width:200,buttons:[{id:"cur-pass-show",img:"img-eye",title:"показать",click:function(){togglePass("cur-pass")}},{id:"cur-pass-check",
img:"img-cir-green",title:"проверить",click:function(){k()}}]}));var e=$("#cur-pass");$("#new-pass-field").replaceWith(field.text("new-pass",{input_type:"password",width:200,buttons:[{id:"new-pass-generate",img:"img-idea",title:"придумать",click:function(){$("#new-pass").val(generatePassword())}},{id:"new-pass-show",img:"img-eye",title:"показать",click:function(){togglePass("new-pass")}},{id:"new-pass-check",img:"img-cir-green",title:"проверить",click:function(){l()}}]}));var f=$("#new-pass"),g=function(){if((!c.val()||
c.data("old")!==c.val())&&c.val())return ui.ajaxLoader(c),$.ajax({type:"POST",dataType:"json",url:"/?action=check.login",data:{"login--login":c.val(),"excludeUser--bool":!0},success:function(a){var b=$("#check-login > button");a.error?(showValidation(a.validation,{messageObject:$("#login-span"),position:"afterObject",id:["login"],fontSize:"12px"}),b.removeClass("img-cir-green"),b.addClass("img-cir-red"),c.data("old","")):(cleanValidation({id:["login"]}),b.removeClass("img-cir-red"),b.addClass("img-cir-green"),
c.data("old",c.val()))}})},k=function(){var a=$("#cur-pass-check > button");$("#cur-pass").val()?(ui.ajaxLoader($("#cur-pass")),$.ajax({type:"POST",url:"/?action=check.curpas",dataType:"json",data:{pass:$("#cur-pass").val()},success:function(b){var c=$("#pass-change");b.error?(c.is(":hidden")&&c.slideDown(),showValidation(b.validation,{messageObject:$("#cur-pass-span"),position:"afterObject",id:"cur-pass"}),a.removeClass("img-cir-green"),a.addClass("img-cir-red")):(cleanValidation({id:"cur-pass"}),
a.removeClass("img-cir-red"),a.addClass("img-cir-green"))}})):(cleanValidation({id:"cur-pass"}),a.addClass("img-cir-green"))},l=function(){var a=$("#new-pass-check > button");$("#new-pass").val()?(ui.ajaxLoader($("#new-pass")),$.ajax({type:"POST",url:"/?action=check.pass",dataType:"json",data:{"pass--password":$("#new-pass").val()},success:function(b){var c=$("#pass-change");b.error?(c.is(":hidden")&&c.slideDown(),showValidation(b.validation,{messageObject:$("#new-pass-span"),position:"afterObject",
id:"new-pass"}),a.removeClass("img-cir-green"),a.addClass("img-cir-red")):(cleanValidation({id:"new-pass"}),a.removeClass("img-cir-red"),a.addClass("img-cir-green"))}})):(cleanValidation({id:"new-pass"}),a.addClass("img-cir-green"))};$("#pass-change-link").click(function(){$("#pass-change").slideToggle()});$("#personal").submit(function(){$("#check-email").click();g();l();k();if(f.val()&&!e.val())showValidation({field:"cur-pass",text:"Для установки нового пароля нужно ввести текущий"},{messageObject:$("#cur-pass-span"),
position:"afterObject",id:"cur-pass"});else{var a=$("#personal");formHelper.ajax({type:"POST",dataType:"json",url:"/?action=personal_info.update",form:a,data:a.serialize(),success:function(a){a.error?popup.info(a.text):(a.isPassChanged&&($("#cur-pass").val(""),$("#new-pass").val("")),popup.info("данные успешно обновлены"),user.data.load(!0))}})}return!1})}
function settingsTab(a){var b=function(){$.ajax({type:"POST",dataType:"json",url:"/?action=settings.update",data:$("#settings").serialize(),success:function(a){a.error?console.log(a.message):user.data.load(!0)}})},c=$("#public-code-link");c.click(function(){popup.show(h.div().a(fh.wrap().a(h.div({html:a,style:"padding-bottom: 8px"}),h.textarea({id:"link_textarea",rows:5,cols:60,html:a})),popup.buttons([formHelper.buttons.close()])),{width:"540px"});$("#link_textarea").select()});$("#public").change(function(){this.checked?
c.fadeIn():c.fadeOut();ui.ajaxLoader($("#public_chb"),{position:"left",offsetLeft:-4});b()});$("#stat-period-cur-date").change(function(){ui.ajaxLoader($("#stat-period-cur-date_chb"),{position:"left",offsetLeft:-4});b()})};var record={form:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.oVal("movements",[]),c=a.oVal("mode",!1),e=a.oVal("recordsTable",!1),f=h.form({id:"recordForm"}),g=function(a){var b=a.currencyId;a=a.accountId;var c=$("#currencyId"),e=k.find("select");e.val(account.defId());c.val(currency.defId());b&&field.selectVal(c,b);a&&field.selectVal(e,a);$("#amount").focus()},k,l,n,p,m,q,r=function(){$("#amount").focus();$("#recordtype-movementDetail").hasClass("sel")&&move.selectsValidate(k.find("select"),
l.find("select"))},t=field.hidden("recordId",{name:"recordId--id"}),u=field.hidden("recordType",{name:"recordType"}).val("entry"),w=ui.buttons([{id:"recordtype-entry",value:"Трата / Доход",selected:!0,tabIndex:1,click:function(){u.val("entry");field.selectSetEnable(k.find("select"));field.selectSetEnable(l.find("select"));ui.fadeInStrict($(".record-accounts").stop(!0));G.hide();H.hide();k.find(".tagcloud").stop(!0).slideDown();l.stop(!0).slideUp();ui.fadeIn($(".record-cats").stop(!0));m.stop(!0).slideDown();
k.stop(!0).slideDown();t.val()||A.stop(!0).show();ui.fadeIn(A.stop(!0));J.stop(!0).slideUp();$("#amount").focus()}},{id:"recordtype-movementDetail",value:"Перемещение",tabIndex:2,click:function(){u.val("movementDetail");move.selectsValidate(k.find("select"),l.find("select"));ui.fadeInStrict($(".record-accounts").stop(!0));k.find(".tagcloud").stop(!0).slideUp($.fx.speeds._default,function(){A.hide();ui.fadeInStrict(G.stop(!0));ui.fadeInStrict(H.stop(!0))});l.stop(!0).slideDown();ui.fadeOut($(".record-cats").stop(!0));
m.stop(!0).slideDown();k.stop(!0).slideDown();J.stop(!0).slideDown();$("#amount").focus()}},{id:"recordtype-note",value:"Заметка",tabIndex:3,click:function(){u.val("note");"editOneRecord"===c&&(n.hide(),m.hide(),p.hide(),q.css({border:0,width:"auto"}));u.val("note");n.stop(!0).slideUp();ui.fadeOut(p.stop(!0));m.stop(!0).slideUp(function(){K.find("textarea").focus()})}}],{id:"record-type"}).css({paddingBottom:"18px"}),v=category.select("expenseCats",{catType:"exp",cssClass:"dcenter",tabIndex:4,change:function(){var a=
x.find(":selected").data("item");a&&(z.val(-1),g(a))},isCloud:!0,cloudOptions:{click:function(a){x.val(a.id).change()},style:"padding: 6px"}}),x=v.find("select"),y=category.select("incomeCats",{catType:"inc",cssClass:"dcenter",tabIndex:5,change:function(){var a=z.find(":selected").data("item");a&&(x.val(-1),g(a))},isCloud:!0,cloudOptions:{click:function(a){z.val(a.id).change()},style:"padding: 6px"}}),z=y.find("select");k=account.select("account1",{cssClass:"dcenter",items:user.account,change:r,isCloud:!0,
cloudOptions:{width:200,fontMin:12,fontMax:16,style:"padding-top: 4px;padding-left: 34px;",percentFilter:.02,isShowOne:!1,click:function(a){$("#account1").val(a.id);$("#amount").focus()}}});var B=k.find("select"),A=h.div({id:"record-move-arrow",c:"large hand inline unselectable",title:"Перемещение между счетами",html:"&nbsp;&rarr;"}).click(function(){t.val()||$("#recordtype-movementDetail").click()}),G=h.div({id:"record-move-arrow-big"}).a(ui.image("180arrow")).css({paddingLeft:"6px"}).click(function(){t.val()||
$("#recordtype-entry").click()}),H=h.div({id:"record-move-arrows"}).a(ui.image("180arrows")).css({paddingRight:"6px"}).click(function(){move.selectsSwap(k.find("select"),l.find("select"));$("#amount").focus()});B.after(A);l=account.select("account2",{cssClass:"dcenter",change:r}).css({marginTop:"7px"});var I=l.find("select"),J=ui.cloud("move-cloud",{fontMin:11,fontMax:13,width:"100%",items:b,limit:3,withBr:!0,itemRender:function(a){return h.nobr().a(a)},click:function(a){a=a.id.split("_");B.val(a[0]).change();
I.val(a[1]).change();C.focus()}}),b=field.date("date",{showNav:!0,navKey:!0,afterSelect:function(){$("#amount").focus()},tabIndex:6,clearButton:!1}).doUnselectable(),N=b.find(".date-input"),O=b.find(".sql-date");m=field.amount("amount",{placeholder:"Сумма",showCurrency:!0,showCalc:!0,tabIndex:7}).css({marginTop:"12px"});var C=m.find("input"),P=m.find("select"),K=field.textarea("comment",{cols:25,rows:2,placeholder:"Комментарий",style:"width:221px;",isAutoHeight:!0}).css({marginTop:"12px"}),F=K.find("textarea"),
L=ui.buttons([{id:"direction-stay",value:"остаться",selected:!0},{id:"direction-stat",value:"в статистику"}],{id:"after-add-direction",c:"small"}).css({padding:"4px 0"}),D=field.button("record-add",{c:"big",type:"submit",hotKey:{key:keys.enter,ctrl:!0},html:h.nobr().a(ui.image("plus vtop"),"&nbsp;Добавить"),hint:"(Ctrl + Enter)"}),Q=D.find('button[type="submit"]'),E=field.button("record-del",{hotKey:{key:keys.del,ctrl:!0},html:h.span().a(ui.image("delete vtop")," Удалить"),hint:"(Ctrl + Del)"});E.find("button").click(function(){E.disable();
ui.ajaxLoader(E.find("#record-del"));record["delete"](f.currentItem,$("#records-table").data("entitiesTable"),function(){f.reset(u.val())})});var M=field.button("record-cancel",{c:"medium",html:"Отмена",hotKey:{key:keys.esc},hint:"(Esc)"}).click(function(){f.reset();$("#amount").focus()}).css({paddingTop:"7px"});f.a(t,u,w,p=h.div({c:"record-cats dcenter"}).a(v,html.br(),y),q=h.div({c:"record-param dcenter vtop"}).a(b,html.br(),m,K,L,n=h.div({c:"table record-accounts"}).a(h.div().a(h.div({c:"cell vmiddle hright"}).a(H.hide()).css({}),
h.div({c:"cell"}).a(k.css({paddingTop:"8px"}),l.hide()).css({width:"1%"}),h.div({c:"cell hleft vmiddle"}).a(G.hide()).css({})),h.div().a(J.hide())).css({padding:"0 0 0 0"}),!a.disableButtons&&h.div().a(h.div({c:"fleft"}).a(E.hide()).css({paddingLeft:"8px"}),h.div({c:"fright"}).a(D,M.hide())).css({paddingTop:"8px"})).css({width:"240px"}));"editOneRecord"===c&&(w.hide(),L.hide(),n.removeClass("table"),A.hide(),k.cloud().css({paddingLeft:0,width:"auto"}),"note"===a.type&&p.hide());f.edit=function(a,
b,e){ui.focusAndEndCursor(m.find("input"));"1"===a.arhive?popup.error("Нельзя редактировать записи, категория, счёт или валюта которых находится в архиве"):("editOneRecord"!==c&&(ui.clearHighlight($(b.selector).find("tbody"),{cssClass:"highlight-green"}),e.removeClass("sel"),e.addClass("highlight-green")),w.find("button").each(function(){ui.disable($(this))}),ui.fadeOut(A.stop(!0)),D.find("button").html("Сохранить"),M.show(),E.show(),t.val()||f.data("state",f.state()),f.setState(a),t.val()?f.currentItem=
a:f.currentItem=null)};f.category=function(){var a=null,b=null;"-1"!==x.val()&&(a="0",b=x.val());"-1"!==z.val()&&(a="1",b=z.val());return{id:b,positive:a}};f.state=function(){var a=f.category();return{type:u.val(),positive:a.positive,categoryId:a.id,date:O.val(),amount:C.val(),currencyId:P.val(),comment:F.val(),accountId:B.val(),fromId:B.val(),toId:I.val()}};f.setState=function(a){t.val(a.id||"");w.find("#recordtype-"+a.type).click();switch(a.type){case "entry":var b={0:x,1:z};a.positive?b[a.positive].val(a.categoryId).change():
(b["1"].val(-1),b["0"].val(-1));a.accountId&&B.val(a.accountId);break;case "movementDetail":B.val(a.fromId).change(),I.val(a.toId).change()}a.date&&N.val(ui.prettyDate(a.date).html()).change();C.val(a.amount);a.currencyId&&P.val(a.currencyId);a.comment?field.textareaResize(F.val(a.comment.htmlDecode())):F.val("")};f.reset=function(a){a=a||"entry";t.val("");D.find("button").html(h.nobr().a(ui.image("plus vtop"),"&nbsp;Добавить"));ui.clearHighlight($("#records-table").find("tbody"),{cssClass:"highlight-green"});
M.hide();E.hide();E.enable();D.enable();w.find("button").each(function(){ui.enable($(this))});"entry"===a&&ui.fadeIn(A);var b=f.data("state");b?f.setState(b):(w.find("#recordtype-"+a).click(),C.val("").focus(),F.val(""))};f.validate=function(){var a=function(a,b){popup.error(a,{afterClose:function(){b&&b.focus()}});return!1};if(!O.val())return a("Дата не может быть пустой",N);if("note"!==u.val()){var b=C.val();if(""===b)return a("Сумма не может быть пустой",C);b=utils.expressionEval(b);if(!1===b)return a("Неверное математическое выражение",
C);C.val(b);if(0>parseFloat(b))return a("Сумма не может отрицательной",C);if(!parseFloat(b))return a("Ошибка в поле сумма",C)}switch(u.val()){case "entry":if("-1"===x.val()&&"-1"===z.val())return a("Выберите категорию",x);break;case "note":if(!F.val())return a("Заметка не может быть пустой",F)}return!0};f.submit(function(){if(!f.validate())return!1;ui.ajaxLoader(Q,{position:"left"});a.inPopup?ui.disable($("#recordForm").find('button[type="submit"]')):D.disable();$.ajax({type:"POST",url:"/?action=records.update",
data:f.serialize(),success:function(){(e||f.recordTable)&&(e||f.recordTable).reload();a.inPopup?popup.kill():(!t.val()&&f.data("state",!1),f.reset(u.val()),category.cntChange(f.category(),1),"0"===f.category().positive?v.cloud().render(category.categories().exp):y.cloud().render(category.categories().inc))}}).always(function(){"direction-stat"===L.selected().attr("id")&&(window.location="/stat");D.enable()}).error(function(){popup.error("Ошибка при обработке записи, обратитесь к разработчику")});
a.afterSubmit&&a.afterSubmit(f.serializeArray());return!1});f.data("form",f);f.incCats=function(){return y};f.expCats=function(){return v};return f},"delete":function(a,b,c){c=c||!1;var e=$("#recordForm"),f=!1;e.length&&(f=e.data("form"));f&&!$("#record-id").val()&&f.data("state",f.state());$.ajax({type:"POST",url:"/?action=records.delete",data:{id:a.id,type:a.type,categoryId:a.categoryId},success:function(){c&&c();b.reload();category.cntChange({id:a.categoryId,positive:a.positive},-1);f&&("0"===
a.positive?f.expCats().cloud().render(category.categories().exp):f.incCats().cloud().render(category.categories().inc));var e=$("#recordForm");0<e.length&&e.data("form").reset()}})},table:function(a,b,c){c=c||{};var e=c.oVal("id",utils.genId("table-")),f=c.oVal("titles",[]),g=c.oVal("minWidth","auto"),k=c.oVal("linkedTables",!1),l=c.oVal("renderTr",!1),n=c.oVal("edit",!1),p=c.oVal("remove",!1),m=c.oVal("dataLink","/?action=records.json");c=c.oVal("filters",{});return new Table({id:e,conteiner:b,dataLink:m,
linkedTables:k,pageCount:10,minWidth:g,filters:c,items:a,titles:f,renderTr:l,edit:n,remove:p})},formShow:function(a,b,c){var e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},f=e.oVal("type","entry");e.oVal("mode",{});e.afterSubmit=function(a){console.log(a,b);a=a.filter(function(a){return"date--date"===a.name})[0].value;var c=$("#entry-period-to"),e=$("#entry-period-from");if(c.length){var c=c.data("dateField"),f=c.mysqlDate();a>f&&(dateHelper.mysqlToPicker(c.picker(),a),b&&(b.filters.to=
a))}e.length&&(e=e.data("dateField"),c=e.mysqlDate(),a<c&&(dateHelper.mysqlToPicker(e.picker(),a),b&&(b.filters.from=a)))};var g=record.form(e),k=[fh.buttons.save()];a.id&&k.push(fh.buttons["delete"](function(){record["delete"](a,e.recordsTable);popup.kill()}));k.push(fh.buttons.cancel(popup.kill));k=popup.show(h.div().css({paddingTop:"14px"}).a(g.a(popup.buttons(k)),{afterClose:function(){(b&&b.linkedTables||e.linkedTables)&&self.linkedTables.forEach(function(a){a.reload()})}}));g.edit({id:a.id,
type:f,comment:a.note||a.comment,date:a.date,amount:a.amount,positive:a.positive,currencyId:a.currencyId,categoryId:a.categoryId,accountId:a.accountId},b,c);k.css({width:k.width()+1+"px"})},renderAmounts:function(a,b){b=b||{};var c=record.amounts(a),e=h.span(),f=b.hasOwnProperty("separately")?b.separately:!1,g=[],k=[];$.each(c,function(a,b){$.each(b,function(b,c){var n=ui.prettyMoney({positive:a,amount:c.sum,currencySymbol:c.symbol});f&&(g.push(c.sum),k.push(c.symbol));e.a(h.span({css:{display:"block"}}).a(n))})});
return f?{amounts:g,curSymbols:k}:e},amounts:function(a){var b={};$.each(a,function(c,e){if(!e.hasOwnProperty("show")||!0===e.show){if("note"===e.type&&"movementDetail"===e.type)return{};if("account"===e.type)$(e.rems).each(function(a,c){var e=parseFloat(c.amount);b.hasOwnProperty(c.currencyId)?b[c.currencyId].sum+=e:b[c.currencyId]={sum:e,currencySymbol:c.currencySymbol}});else{var f=e.currencySymbol,g=e.currencyId,k=parseFloat(e.amount),l="1"===e.positive?"0":"1";e.hasOwnProperty("rd")&&console.error("value in record.amounts has rd",
a,e);"debt"===e.type&&(k=parseFloat(e.amount-e.dhamount));b.hasOwnProperty(l)?b[l].hasOwnProperty(g)?b[l][g].sum+=k:b[l][g]={sum:k,symbol:f}:(b[l]={},b[l][g]={sum:k,symbol:f})}}});return b}};var entry={filterItem:function(a,b){if(a.filters.category){var c=a.filters.category,e=c.incCats,f=c.expCats,g=c.inc,c=c.exp,k=parseInt(b.categoryId);if(g&&!g.value&&"1"===b.positive||c&&!c.value&&"0"===b.positive||e&&"1"===b.positive&&-1===e.value.indexOf(k)||f&&"0"===b.positive&&-1===f.value.indexOf(k))return!1}if(a.filters.amount){k=a.filters.amount;e=k.account;f=k.currency;g=k.comment;c=parseFloat(k.from);k=parseFloat(k.to);if(e&&-1===e.indexOf(parseInt(b.accountId))||f&&-1===f.indexOf(parseInt(b.currencyId))||
c&&parseFloat(b.amount)<c||k&&parseFloat(b.amount)>k)return!1;if(g){var l=!1;g.split(/\s+/).forEach(function(a){a&&b.comment.includes(a)&&(l=!0)});if(!l)return!1}}return!0},makeTitles:function(a,b,c){c=c||{};var e=c.oVal("isEmpty",!1);c=c.oVal("colspan",!1);var f="month"===a.groupBy;if(e)a.publicUser||!a.filters.category&&!a.filters.amount?b.html(h.tr().a(h.th({colspan:c,css:{borderBottom:"1px solid black"}})).html()):(b.find("tr:first").remove(),b.find("tr:last").remove(),b.find("th").not(":first").not(":last").remove(),
b.find("th").css({borderBottom:"1px solid black"}));else{a.publicUser=a.rawData.oVal("publicUser",!1);e=a.rawData;c=e.entry;var g=e.note,k=h.tr({c:"years"}).a(h.th()),l=h.tr({c:"months"}).a(a.publicUser?h.th().html("Категории"):ui.makeFilteredTh(a,1,{title:"Категории",filter:{type:"statCategory"},filterVal:a.filters.category||{},position:"left"})),n=h.tr({c:"days"}).a(h.th()),p=[],m=[];$.each(c,function(b,c){entry.filterItem(a,c)&&p.push(c.date)});$.each(g,function(a,b){!f&&m.push(b.date)});e=p.concat(m).filter(function(a,
b,c){return c.indexOf(a)===b}).map(function(a){return dateHelper.mysqlToDate(a)}).sort(function(a,b){return a-b});a.cache.dates=e;e=e.reduce(function(a,b){var c=b.getFullYear(),e=b.getMonth(),f=b.getDate(),g={date:dateHelper.mysqlFromDate(b)};c in a||(a[c]=[]);e in a[c]||(a[c][e]=[]);g.val=dateHelper.isWeekend(b)?h.span({css:{color:"red"}}).a(f):f;a[c][e].push(g);return a},[]);!f&&(g=g.reduce(function(a,b){var c=b.date;c in a||(a[c]=[]);a[c].push(b);return a},[]));e.forEach(function(b,c){var e=0;
b.forEach(function(b,c){var k=Object.keys(b).length;e+=f?1:k;l.a(h.th(f?{}:{colspan:k}).html(dateHelper.monthName(c)));!f&&b.forEach(function(b){var c=b.date,e=h.span(),f=[];c in g&&g[c].forEach(function(a){e.a(h.div({c:"row"}).a(h.div({c:"cell xsmall"}).a(a.time).css({padding:"8px 4px"}),h.div({c:"cell"}).a(a.note.nl2br().truncate({maxWidth:350,showRowsCount:4}))));f.push(a)});b=h.th().html(b.val).data({date:c});e.html()&&(b.addClass("comment"),b.prop("title",e.html()),a.isPublic&&b.css({cursor:"auto"}),
!a.isPublic&&b.click(function(){if(1<f.length){var b=h.div({id:"noteDiv"}).css({padding:"24px"});note.table(f,b,{linkedTables:[a]}).show();popup.show(h.span().a(b,popup.buttons([fh.buttons.close()])))}else note.edit(f[0],null,null,{linkedTables:[a]})}));n.a(b)});f&&n.a(h.th().html(""))});k.a(h.th({colspan:e}).html(c))});k.a(h.th());l.a(a.publicUser?h.th().html("Суммы"):ui.makeFilteredTh(a,2,{title:"Суммы",filter:{type:"statAmount"},filterVal:a.filters.amount||{},position:"right"}));n.a(h.th());b.a(k,
l,n)}},amounts:function(a){return a.reduce(function(a,c){c.positive in a||(a[c.positive]={});c.currencyId in a[c.positive]||(a[c.positive][c.currencyId]={amount:0,symbol:c.symbol});a[c.positive][c.currencyId].amount+=parseFloat(c.amount);return a},{})},renderAmounts:function(a,b){b=b||{};var c=h.span(),e=b.oVal("symbolMaxWidth",0),f={},g=b.oVal("defCurId",!1),g=g||user.def.currencyId;f[g]=h.div({c:"iblock"}).css({width:e});$.each(a,function(a,b){$.each(b,function(b,g){0<e&&(b in f||(f[b]=h.div({c:"iblock"}).css({width:e}).html(g.symbol)));
var l=0<e?f[b].outerHtml():" ",l=ui.prettyMoney({positive:a,amount:g.amount,currencySymbol:l});c.a(h.div().a(0<e&&h.symbols.shortSpace&&h.div({c:"iblock"}).css({width:e}),l))})});return c},prepareData:function(a){var b=a.rawData,c=b.entry,e=b.note,f=a.cache.dates.map(function(a){return dateHelper.mysqlFromDate(a)}),g=[],k=[],l=0;"month"===a.groupBy&&(f=f.reduce(function(a,b){var c=b.split("-"),c=parseInt(c[0])+"-"+parseInt(c[1]);-1===a.indexOf(c)&&a.push(c);return a},[]));a.publicUser=b.oVal("publicUser",
!1);a.publicUserDefaultCurrencyId=a.publicUser?a.publicUser.defCurrencyId:!1;if(!c&&!e)return[];var n=a.publicUser?a.publicUser.defCurrencyId:user.def.currencyId,c=c.filter(function(b){return entry.filterItem(a,b)}),p=c.reduce(function(a,b){var c=b.categoryName,e=b.symbol;c in a||(a[c]=[]);a[c].push(b);-1===k.indexOf(e)&&b.currencyId!==n&&k.push(e);return a},{});k.length&&k.forEach(function(a){a=h.span({html:a}).measure(function(){return this.width()});a>l&&(l=a)});a.cache.symbolMaxWidth=l;var m=
{},q={};f.forEach(function(b,c){var e=!0;$.each(p,function(k,n){0===c&&g.push([k]);var r=Object.keys(p).indexOf(k),z=[];n.forEach(function(f){var g=dateHelper.mysqlToDate(f.date),g=g.getFullYear()+"-"+(g.getMonth()+1);if("month"===a.groupBy?g===b:f.date===b)z.push(f),e=!1,c in q||(q[c]=[]),q[c].push(f);0===c&&(r in m||(m[r]=[]),m[r].push(f))});g[r].push(z);if(c===f.length-1){var B=entry.amounts(m[r]),A=entry.renderAmounts(B,{symbolMaxWidth:l,defCurId:a.publicUserDefaultCurrencyId});g[r].push({catAmounts:A,
catAmountsRaw:B})}});e&&(c in q||(q[c]=[]),q[c].push([]))});a.cache.catEntries=m;var r=[""];$.each(q,function(b,c){0!==c[0].length?r.push(entry.renderAmounts(entry.amounts(c),{symbolMaxWidth:l,defCurId:a.publicUserDefaultCurrencyId})):r.push("")});r.push(entry.renderAmounts(entry.amounts(c),{symbolMaxWidth:l,defCurId:a.publicUserDefaultCurrencyId}));a.cache.footerAmounts=r;return g},renderFooter:function(a){var b=a.tfoot,c=h.tr();a.cache.footerAmounts.forEach(function(a){c.a(h.td().a(a))});b.a(c)},
renderStatTr:function(a,b,c){b.forEach(function(b){if(0===b.length)a.a(h.td({c:"empty"}));else if("string"===typeof b)a.a(h.td({html:b.truncate({maxWidth:230,oneWord:!0})}));else if(b.hasOwnProperty("catAmounts"))a.a(h.td().a(b.catAmounts));else{var f=entry.renderAmounts(entry.amounts(b),{symbolMaxWidth:c.cache.symbolMaxWidth,defCurId:c.publicUserDefaultCurrencyId}),g=h.div({c:"table"}),f=h.td().a(f),k=function(a,b,c){"1"===a.category_arhive||"1"===a.currency_arhive||"1"===a.account_arhive?popup.error("Нельзя редактировать запись у которой валюта, счёт или категория находятся в архиве"):
(b={mode:"editOneRecord",disableButtons:!0,type:"entry",inPopup:!0,recordsTable:b,linkedTables:[c]},c&&(b.linkedTables=[c]),record.formShow(a,null,null,b))};c.isPublic&&f.css({cursor:"auto"});!c.isPublic&&f.click(function(){if(1===b.length)k(b[0],c);else{var a=h.div({id:"entryDiv"}).css({padding:"24px"}),f=b[0];record.table(b,a,{titles:[{c:"date"},{c:"text"},{c:"amount"},{c:"account"},{c:"text"}],filters:{note:!1,entry:!0,move:!1,entryDate:f.date,categoryId:f.categoryId},renderTr:entry.renderTr,edit:function(a,
b){k(a,b,c)},remove:record["delete"],linkedTables:[c]}).show();popup.show(h.span().a(a,popup.buttons([fh.buttons.close()])))}});$.each(b,function(a,c){c.comment&&g.a(h.div({c:"row"}).a(1<b.length&&h.div({c:"cell nobr hright"}).a(c.amount.formatMoney(),h.symbols.shortSpace,c.symbol).css({paddingRight:"12px"}),h.div({c:"cell"}).a(c.comment.nl2br()).css({paddingBottom:1<b.length?"8px":0})))});g.html()&&(f.addClass("comment"),f.prop("title",g.outerHtml()));a.a(f)}})},bindEvent:function(a,b){$(function(){var c=
!1,e,f="#"+a.id+" tbody",g=$("#"+b);$(f).hover(function(){},function(){c=!1});$(f).on({mousemove:function(a){c&&g.scrollLeft(e-a.pageX)},mouseup:function(){c=!1},mousedown:function(a){c=!0;e=g.scrollLeft()+a.pageX}})})},afterShow:function(a){$(function(){var b=$("#entryWrapper"),c=$("#period");entry.bindEvent(a,"entryWrapper");b.scrollLeft($("#entry").width());a.publicUser&&h.div({html:"Пользователь: {0} ({1} {2})".f(a.publicUser.login,a.publicUser.curName,a.publicUser.defSymbol)}).css({padding:"8px"}).insertAfter(c)})},
renderTr:function(a,b){var c=h.td().a(b.comment.truncate({oneWord:!0,maxWidth:fh.fieldMediumWidth})),e=h.td().a(b.categoryName.truncate({oneWord:!0,maxWidth:category.maxWidth})),f=ui.itemAmount(b).amountWithoutComment,g=h.td().a(b.accountName.truncate({oneWord:!0,maxWidth:account.maxWidth})),k=ui.prettyDateTd(b.date);a.a(k,e,f,g,c)}};
